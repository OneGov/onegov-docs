
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>onegov.org.app &#8212; OneGov Docs 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for onegov.org.app</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Contains the base application used by other applications. &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">chameleon</span> <span class="k">import</span> <span class="n">PageTemplate</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">dectate</span> <span class="k">import</span> <span class="n">directive</span>
<span class="kn">from</span> <span class="nn">more.content_security</span> <span class="k">import</span> <span class="n">SELF</span>
<span class="kn">from</span> <span class="nn">onegov.core</span> <span class="k">import</span> <span class="n">Framework</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">onegov.core.framework</span> <span class="k">import</span> <span class="n">default_content_security_policy</span>
<span class="kn">from</span> <span class="nn">onegov.core.i18n</span> <span class="k">import</span> <span class="n">default_locale_negotiator</span>
<span class="kn">from</span> <span class="nn">onegov.core.orm</span> <span class="k">import</span> <span class="n">orm_cached</span>
<span class="kn">from</span> <span class="nn">onegov.file</span> <span class="k">import</span> <span class="n">DepotApp</span>
<span class="kn">from</span> <span class="nn">onegov.form</span> <span class="k">import</span> <span class="n">FormApp</span>
<span class="kn">from</span> <span class="nn">onegov.gis</span> <span class="k">import</span> <span class="n">MapboxApp</span>
<span class="kn">from</span> <span class="nn">onegov.org</span> <span class="k">import</span> <span class="n">directives</span>
<span class="kn">from</span> <span class="nn">onegov.org.homepage_widgets</span> <span class="k">import</span> <span class="n">transform_homepage_structure</span>
<span class="kn">from</span> <span class="nn">onegov.org.initial_content</span> <span class="k">import</span> <span class="n">create_new_organisation</span>
<span class="kn">from</span> <span class="nn">onegov.org.models</span> <span class="k">import</span> <span class="n">Topic</span><span class="p">,</span> <span class="n">Organisation</span>
<span class="kn">from</span> <span class="nn">onegov.org.request</span> <span class="k">import</span> <span class="n">OrgRequest</span>
<span class="kn">from</span> <span class="nn">onegov.org.theme</span> <span class="k">import</span> <span class="n">OrgTheme</span>
<span class="kn">from</span> <span class="nn">onegov.page</span> <span class="k">import</span> <span class="n">Page</span><span class="p">,</span> <span class="n">PageCollection</span>
<span class="kn">from</span> <span class="nn">onegov.pay</span> <span class="k">import</span> <span class="n">PayApp</span>
<span class="kn">from</span> <span class="nn">onegov.reservation</span> <span class="k">import</span> <span class="n">LibresIntegration</span>
<span class="kn">from</span> <span class="nn">onegov.search</span> <span class="k">import</span> <span class="n">ElasticsearchApp</span>
<span class="kn">from</span> <span class="nn">onegov.ticket</span> <span class="k">import</span> <span class="n">TicketCollection</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">desc</span>


<div class="viewcode-block" id="OrgApp"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.app.OrgApp">[docs]</a><span class="k">class</span> <span class="nc">OrgApp</span><span class="p">(</span><span class="n">Framework</span><span class="p">,</span> <span class="n">LibresIntegration</span><span class="p">,</span> <span class="n">ElasticsearchApp</span><span class="p">,</span> <span class="n">MapboxApp</span><span class="p">,</span>
             <span class="n">DepotApp</span><span class="p">,</span> <span class="n">PayApp</span><span class="p">,</span> <span class="n">FormApp</span><span class="p">):</span>

    <span class="n">serve_static_files</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">request_class</span> <span class="o">=</span> <span class="n">OrgRequest</span>

    <span class="c1">#: org directives</span>
    <span class="n">homepage_widget</span> <span class="o">=</span> <span class="n">directive</span><span class="p">(</span><span class="n">directives</span><span class="o">.</span><span class="n">HomepageWidgetAction</span><span class="p">)</span>
    <span class="n">export</span> <span class="o">=</span> <span class="n">directive</span><span class="p">(</span><span class="n">directives</span><span class="o">.</span><span class="n">ExportAction</span><span class="p">)</span>
    <span class="n">userlinks</span> <span class="o">=</span> <span class="n">directive</span><span class="p">(</span><span class="n">directives</span><span class="o">.</span><span class="n">UserlinkAction</span><span class="p">)</span>
    <span class="n">directory_search_widget</span> <span class="o">=</span> <span class="n">directive</span><span class="p">(</span><span class="n">directives</span><span class="o">.</span><span class="n">DirectorySearchWidgetAction</span><span class="p">)</span>

    <span class="c1">#: the version of this application (do not change manually!)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;0.31.1&#39;</span>

<div class="viewcode-block" id="OrgApp.is_allowed_application_id"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.app.OrgApp.is_allowed_application_id">[docs]</a>    <span class="k">def</span> <span class="nf">is_allowed_application_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Stops onegov.server from ever passing the request to the org</span>
<span class="sd">        application, if the schema does not exist. This way we can host</span>
<span class="sd">        onegov.org in a way that allows all requests to *.example.org</span>

<span class="sd">        If the schema for ``newyork.example.org`` exists, the request is</span>
<span class="sd">        handled. If the schema does not exist, the request is not handled.</span>

<span class="sd">        Here we basically decide if an org exists or not.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">application_id</span>

        <span class="k">if</span> <span class="n">schema</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_schemas</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># block invalid schemas from ever being checked</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_manager</span><span class="o">.</span><span class="n">is_valid_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># if the schema exists, remember it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_manager</span><span class="o">.</span><span class="n">is_schema_found_on_database</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">known_schemas</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="OrgApp.configure_application"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.app.OrgApp.configure_application">[docs]</a>    <span class="k">def</span> <span class="nf">configure_application</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">configure_application</span><span class="p">(</span><span class="o">**</span><span class="n">cfg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">known_schemas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_database_connection</span><span class="p">:</span>
            <span class="n">schema_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">known_schemas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_manager</span><span class="o">.</span><span class="n">list_schemas</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">schema_prefix</span><span class="p">)</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">configure_organisation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_user_registration</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;enable_user_registration&#39;</span><span class="p">,</span>
            <span class="kc">False</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enable_yubikey</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;enable_yubikey&#39;</span><span class="p">,</span>
            <span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">configure_sentry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentry_js</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sentry_js&#39;</span><span class="p">)</span>

    <span class="nd">@orm_cached</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="s1">&#39;on-table-change:organisations&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">org</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Organisation</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="nd">@orm_cached</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="s1">&#39;on-table-change:pages&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">root_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">PageCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">())</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ordered</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">Page</span><span class="o">.</span><span class="n">type</span><span class="p">),</span> <span class="n">Page</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Page</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="nd">@orm_cached</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="s1">&#39;on-table-change:organisations&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">homepage_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;homepage_structure&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">structure</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PageTemplate</span><span class="p">(</span><span class="n">transform_homepage_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PageTemplate</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nd">@orm_cached</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="s1">&#39;on-table-change:tickets&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ticket_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TicketCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">())</span><span class="o">.</span><span class="n">get_count</span><span class="p">()</span>

    <span class="nd">@orm_cached</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="s1">&#39;on-table-change:pages&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">homepage_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="n">PageCollection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">())</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Topic</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;topic&#39;</span><span class="p">)</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Topic</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;is_visible_on_homepage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">pages</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">is_visible_on_homepage</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">],</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">normalize_for_url</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="p">))</span>

        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="OrgApp.send_email"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.app.OrgApp.send_email">[docs]</a>    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Wraps :meth:`onegov.core.framework.Framework.send_email`, setting</span>
<span class="sd">        the reply_to address by using the reply address from the organisation</span>
<span class="sd">        settings.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;marketing&#39;</span><span class="p">)</span>

        <span class="n">reply_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reply_to&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reply_to&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">reply_to</span> <span class="o">=</span> <span class="n">reply_to</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mail</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s1">&#39;sender&#39;</span><span class="p">]</span>
        <span class="n">reply_to</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">reply_to</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">reply_to</span><span class="o">=</span><span class="n">reply_to</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">theme_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">theme_options</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">checkout_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">button_label</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">locale</span><span class="p">):</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_payment_provider</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">provider</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">checkout</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">button_label</span><span class="p">,</span>
            <span class="s1">&#39;amount&#39;</span><span class="p">:</span> <span class="n">price</span> <span class="ow">and</span> <span class="n">price</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
            <span class="s1">&#39;currency&#39;</span><span class="p">:</span> <span class="n">price</span> <span class="ow">and</span> <span class="n">price</span><span class="o">.</span><span class="n">currency</span><span class="p">,</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="n">email</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;locale&#39;</span><span class="p">:</span> <span class="n">locale</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;allowRememberMe&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">square_logo_url</span><span class="p">:</span>
            <span class="n">checkout</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">square_logo_url</span>

        <span class="k">return</span> <span class="n">provider</span><span class="o">.</span><span class="n">checkout_button</span><span class="p">(</span><span class="o">**</span><span class="n">checkout</span><span class="p">)</span></div>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset_path</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_shared_assets_path</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">module_path</span><span class="p">(</span><span class="s1">&#39;onegov.shared&#39;</span><span class="p">,</span> <span class="s1">&#39;assets/js&#39;</span><span class="p">)</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;i18n&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;locales&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_i18n_used_locales</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;de_CH&#39;</span><span class="p">,</span> <span class="s1">&#39;fr_CH&#39;</span><span class="p">}</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;i18n&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;localedirs&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_i18n_localedirs</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">module_path</span><span class="p">(</span><span class="s1">&#39;onegov.org&#39;</span><span class="p">,</span> <span class="s1">&#39;locale&#39;</span><span class="p">),</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">module_path</span><span class="p">(</span><span class="s1">&#39;onegov.form&#39;</span><span class="p">,</span> <span class="s1">&#39;locale&#39;</span><span class="p">),</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">module_path</span><span class="p">(</span><span class="s1">&#39;onegov.user&#39;</span><span class="p">,</span> <span class="s1">&#39;locale&#39;</span><span class="p">)</span>
    <span class="p">]</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;i18n&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;default_locale&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_i18n_default_locale</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;de_CH&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;i18n&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;locale_negotiator&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_locale_negotiator</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">locale_negotiator</span><span class="p">(</span><span class="n">locales</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">org</span><span class="p">:</span>
            <span class="n">locales</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">locales</span> <span class="ow">or</span> <span class="n">get_i18n_default_locale</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">locales</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">locales</span> <span class="o">=</span> <span class="p">(</span><span class="n">locales</span><span class="p">,</span> <span class="p">)</span>

            <span class="k">return</span> <span class="n">default_locale_negotiator</span><span class="p">(</span><span class="n">locales</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="ow">or</span> <span class="n">locales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default_locale_negotiator</span><span class="p">(</span><span class="n">locales</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">locale_negotiator</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">static_directory</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_static_directory</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;static&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">template_directory</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_template_directory</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;templates&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;core&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;theme&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_theme</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">OrgTheme</span><span class="p">()</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;content_security_policy&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">org_content_security_policy</span><span class="p">():</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="n">default_content_security_policy</span><span class="p">()</span>

    <span class="n">policy</span><span class="o">.</span><span class="n">child_src</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">SELF</span><span class="p">)</span>
    <span class="n">policy</span><span class="o">.</span><span class="n">child_src</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;https://*.youtube.com&#39;</span><span class="p">)</span>
    <span class="n">policy</span><span class="o">.</span><span class="n">child_src</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;https://*.vimeo.com&#39;</span><span class="p">)</span>
    <span class="n">policy</span><span class="o">.</span><span class="n">child_src</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;https://checkout.stripe.com&#39;</span><span class="p">)</span>

    <span class="n">policy</span><span class="o">.</span><span class="n">connect_src</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">SELF</span><span class="p">)</span>
    <span class="n">policy</span><span class="o">.</span><span class="n">connect_src</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;https://checkout.stripe.com&#39;</span><span class="p">)</span>
    <span class="n">policy</span><span class="o">.</span><span class="n">connect_src</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;https://sentry.io&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">policy</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;create_new_organisation&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_create_new_organisation_factory</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">create_new_organisation</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;status_mail_roles&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_status_mail_roles</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;editor&#39;</span><span class="p">)</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ticket_manager_roles&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_ticket_manager_roles</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;editor&#39;</span><span class="p">)</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;require_complete_userprofile&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_require_complete_userprofile</span><span class="p">():</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;is_complete_userprofile&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_is_complete_userprofile_handler</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">is_complete_userprofile</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">is_complete_userprofile</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;org&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;default_directory_search_widget&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_default_directory_search_widget</span><span class="p">():</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset_path</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_js_path</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;assets/js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset_path</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_css_path</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;assets/css&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset_output</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_webasset_output</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;assets/bundles&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;sortable&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_sortable_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;sortable.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;sortable_custom.js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;fullcalendar&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_fullcalendar_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;fullcalendar.css&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;fullcalendar.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;fullcalendar.de.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;fullcalendar.fr.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;reservationcalendar.jsx&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;reservationcalendar_custom.js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;check_contrast&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_check_contrast_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;check_contrast.js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;code_editor&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_code_editor_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;ace.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;ace-mode-form.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;ace-mode-xml.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;ace-mode-yaml.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;ace-theme-tomorrow.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;formcode&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;code_editor.js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;editor&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_editor_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;bufferbuttons.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;definedlinks.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;filemanager.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;imagemanager.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;redactor.de.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;redactor.fr.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;input_with_button.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;editor.js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;timeline&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_timeline_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;timeline.jsx&#39;</span>


<span class="c1"># do NOT minify the redactor, or the copyright notice goes away, which</span>
<span class="c1"># is something we are not allowed to do per our license</span>
<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;redactor&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;js&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">get_redactor_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;redactor.min.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;redactor.css&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;dropzone&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_dropzone_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;dropzone.js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;editalttext&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_editalttext_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;editalttext.js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;prompt&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_prompt</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;prompt.jsx&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;photoswipe&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_photoswipe_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;photoswipe.css&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;photoswipe-skin.css&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;photoswipe.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;photoswipe-ui.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;photoswipe-custom.js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;tags-input&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_tags_input</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;tags-input.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;tags-input-setup.js&#39;</span>


<span class="nd">@OrgApp</span><span class="o">.</span><span class="n">webasset</span><span class="p">(</span><span class="s1">&#39;common&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_common_asset</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s1">&#39;global.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;polyfills.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;jquery.datetimepicker.css&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;locale.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;modernizr.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;jquery.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;foundation.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;foundation.alert.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;foundation.dropdown.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;foundation.orbit.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;foundation.reveal.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;foundation.topbar.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;intercooler.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;underscore.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;react.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;react-dom.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;form_dependencies.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;confirm.jsx&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;typeahead.jsx&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;leaflet&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;pay&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;moment.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;moment.de-ch.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;moment.fr-ch.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;jquery.datetimepicker.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;jquery.mousewheel.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;jquery.popupoverlay.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;jquery.load.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;videoframe.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;datetimepicker.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;url.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;date-range-selector.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;lazyalttext.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;lazysizes.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;toggle.js&#39;</span>
    <span class="k">yield</span> <span class="s1">&#39;common.js&#39;</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=OneGov&repo=onegov-docs&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Verein OneGov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>
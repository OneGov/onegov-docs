
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>onegov.org.utils &#8212; OneGov Docs 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for onegov.org.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">colorsys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sedate</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">onegov.core.cache</span> <span class="k">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">isodate</span> <span class="k">import</span> <span class="n">parse_date</span><span class="p">,</span> <span class="n">parse_datetime</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">groupby</span>
<span class="kn">from</span> <span class="nn">libres.modules</span> <span class="k">import</span> <span class="n">errors</span> <span class="k">as</span> <span class="n">libres_errors</span>
<span class="kn">from</span> <span class="nn">lxml.html</span> <span class="k">import</span> <span class="n">fragments_fromstring</span><span class="p">,</span> <span class="n">tostring</span>
<span class="kn">from</span> <span class="nn">onegov.file</span> <span class="k">import</span> <span class="n">File</span><span class="p">,</span> <span class="n">FileCollection</span>
<span class="kn">from</span> <span class="nn">onegov.org</span> <span class="k">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">onegov.org.elements</span> <span class="k">import</span> <span class="n">DeleteLink</span><span class="p">,</span> <span class="n">Link</span>
<span class="kn">from</span> <span class="nn">onegov.ticket</span> <span class="k">import</span> <span class="n">TicketCollection</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">attrgetter</span>
<span class="kn">from</span> <span class="nn">purl</span> <span class="k">import</span> <span class="n">URL</span>


<div class="viewcode-block" id="djb2_hash"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.utils.djb2_hash">[docs]</a><span class="k">def</span> <span class="nf">djb2_hash</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Implementation of the djb2 hash, a simple hash function with a</span>
<span class="sd">    configurable table size.</span>

<span class="sd">    ** Do NOT use for cryptography! **</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># arbitrary large prime number to initialize</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="mi">5381</span>

    <span class="c1"># hash(i) = hash(i-1) * 33 + str[i]</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="p">((</span><span class="nb">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="nb">hash</span><span class="p">)</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

    <span class="c1"># Output: integer between 0 and size-1 (inclusive)</span>
    <span class="k">return</span> <span class="nb">hash</span> <span class="o">%</span> <span class="n">size</span></div>


<div class="viewcode-block" id="get_user_color"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.utils.get_user_color">[docs]</a><span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_user_color</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Gets a user color for each username which is used for the</span>
<span class="sd">    user-initials-* elements. Each username is mapped to a color.</span>

<span class="sd">    Since the colorspace is very limited there are lots of collisions.</span>

<span class="sd">    :returns: The user color in an css rgb string.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">h</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">djb2_hash</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="mi">360</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">colorsys</span><span class="o">.</span><span class="n">hls_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;#</span><span class="si">{0:02x}{1:02x}{2:02x}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)),</span>
        <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)),</span>
        <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">format_time_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">correct_time_range</span><span class="p">(</span><span class="s1">&#39;{:%H:%M} - {:%H:%M}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">correct_time_range</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;00:00&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">string</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;24:00&#39;</span>
    <span class="k">return</span> <span class="n">string</span>


<div class="viewcode-block" id="add_class_to_node"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.utils.add_class_to_node">[docs]</a><span class="k">def</span> <span class="nf">add_class_to_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">classname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Adds the given classname to the given lxml node&#39;s class list. &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;class&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">classname</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">classname</span></div>


<div class="viewcode-block" id="annotate_html"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.utils.annotate_html">[docs]</a><span class="k">def</span> <span class="nf">annotate_html</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Takes the given html and annotates the following elements for some</span>
<span class="sd">    advanced styling:</span>

<span class="sd">        * Every paragraph containing an img element will be marked with the</span>
<span class="sd">          `has-img` class.</span>

<span class="sd">        * If a link is found which points to a youtube or a vimeo video, the</span>
<span class="sd">          link itself as well as the surrounding paragraph is marked</span>
<span class="sd">          with the `has-video` class</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">html</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">html</span>

    <span class="n">fragments</span> <span class="o">=</span> <span class="n">fragments_fromstring</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># we perform a root xpath lookup, which will result in all paragraphs</span>
    <span class="c1"># being looked at - so we don&#39;t need to loop over all elements (yah, it&#39;s</span>
    <span class="c1"># a bit weird)</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">[:</span><span class="mi">1</span><span class="p">]:</span>

        <span class="c1"># instead of failing, lxml will return strings instead of elements if</span>
        <span class="c1"># they can&#39;t be parsed.. so we have to inspect the objects</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s1">&#39;xpath&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">html</span>

        <span class="k">for</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//p[img]&#39;</span><span class="p">):</span>
            <span class="n">add_class_to_node</span><span class="p">(</span><span class="n">paragraph</span><span class="p">,</span> <span class="s1">&#39;has-img&#39;</span><span class="p">)</span>

        <span class="n">condition</span> <span class="o">=</span> <span class="s1">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s1">&#39;starts-with(@href, &quot;</span><span class="si">{}</span><span class="s1">&quot;)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="p">{</span>
                <span class="s1">&#39;https://www.youtube.com&#39;</span><span class="p">,</span>
                <span class="s1">&#39;https://www.vimeo.com&#39;</span><span class="p">,</span>
                <span class="s1">&#39;https://vimeo&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//a[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">condition</span><span class="p">)):</span>
            <span class="n">add_class_to_node</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s1">&#39;has-video&#39;</span><span class="p">)</span>

            <span class="c1"># find the closest paragraph in the ancestrage, but don&#39;t look far</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
                    <span class="n">add_class_to_node</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s1">&#39;has-video&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;//img&#39;</span><span class="p">):</span>
            <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;lazyload-alt&#39;</span><span class="p">)</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="p">:</span>
        <span class="n">set_image_sizes</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tostring</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">fragments</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">set_image_sizes</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">internal_src</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*/storage/([a-z0-9]+)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_image_id</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">internal_src</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">match</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">images</span> <span class="o">=</span> <span class="p">{</span><span class="n">get_image_id</span><span class="p">(</span><span class="n">img</span><span class="p">):</span> <span class="n">img</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">images</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">FileCollection</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">session</span><span class="p">(),</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">File</span><span class="o">.</span><span class="n">reference</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">images</span><span class="p">))</span>

        <span class="n">sizes</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">reference</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">q</span><span class="p">}</span>

        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
                <span class="n">image</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="n">sizes</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">image</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">sizes</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<div class="viewcode-block" id="parse_fullcalendar_request"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.utils.parse_fullcalendar_request">[docs]</a><span class="k">def</span> <span class="nf">parse_fullcalendar_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">timezone</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parses start and end from the given fullcalendar request. It is</span>
<span class="sd">    expected that no timezone is passed (the default).</span>

<span class="sd">    See `&lt;http://fullcalendar.io/docs/timezone/timezone/&gt;`_</span>

<span class="sd">    :returns: A tuple of timezone-aware datetime objects or (None, None).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">parse_datetime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">parse_datetime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">parse_date</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">parse_date</span><span class="p">(</span><span class="n">end</span><span class="p">),</span> <span class="n">time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">999999</span><span class="p">))</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">sedate</span><span class="o">.</span><span class="n">replace_timezone</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">timezone</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">sedate</span><span class="o">.</span><span class="n">replace_timezone</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">timezone</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<span class="k">def</span> <span class="nf">render_time_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="s1">&#39;{:%H:%M}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">==</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;24:00&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;{:%H:%M}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39; - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ReservationInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">,</span> <span class="s1">&#39;reservation&#39;</span><span class="p">,</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="s1">&#39;translate&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">reservation</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span> <span class="o">=</span> <span class="n">reservation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">translate</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="o">.</span><span class="n">display_start</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sedate</span><span class="o">.</span><span class="n">is_whole_day</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="o">.</span><span class="n">timezone</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Whole day&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_time_range</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="o">.</span><span class="n">display_start</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="o">.</span><span class="n">display_end</span><span class="p">()</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delete_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">query_param</span><span class="p">(</span><span class="s1">&#39;csrf-token&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">new_csrf_token</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="o">.</span><span class="n">price</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">price</span> <span class="ow">and</span> <span class="n">price</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
            <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_link</span><span class="p">,</span>
            <span class="s1">&#39;quota&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="o">.</span><span class="n">quota</span><span class="p">,</span>
            <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservation</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;price&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">price</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">AllocationEventInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;allocation&#39;</span><span class="p">,</span> <span class="s1">&#39;availability&#39;</span><span class="p">,</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="s1">&#39;translate&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allocation</span><span class="p">,</span> <span class="n">availability</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span> <span class="o">=</span> <span class="n">allocation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">=</span> <span class="n">availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">translate</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_allocations</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">allocations</span><span class="p">):</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">allocations</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_start&#39;</span><span class="p">)):</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="n">availability</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">queries</span><span class="o">.</span><span class="n">availability_by_allocations</span><span class="p">(</span>
                <span class="n">grouped</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">allocation</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">allocation</span><span class="o">.</span><span class="n">is_master</span><span class="p">:</span>
                    <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="bp">cls</span><span class="p">(</span>
                            <span class="n">allocation</span><span class="p">,</span>
                            <span class="n">availability</span><span class="p">,</span>
                            <span class="n">request</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">events</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">event_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">display_start</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">event_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">display_end</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">event_identification</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;{:</span><span class="si">%d</span><span class="s1">.%m.%Y}: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">display_start</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_time</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">event_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">whole_day</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Whole day&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_time_range</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">display_start</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">display_end</span><span class="p">()</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">quota</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">quota</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">quota_left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quota</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">event_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">partly_available</span><span class="p">:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{percent}</span><span class="s2">% Available&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;percent&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="p">)</span>
            <span class="p">}))</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">quota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quota</span>
            <span class="n">quota_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quota_left</span>

            <span class="k">if</span> <span class="n">quota</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">quota_left</span><span class="p">:</span>
                    <span class="n">available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Available&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Unavailable&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;$</span><span class="si">{num}</span><span class="s2">/$</span><span class="si">{max}</span><span class="s2"> Available&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;num&#39;</span><span class="p">:</span> <span class="n">quota_left</span><span class="p">,</span>
                        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">quota</span>
                    <span class="p">})</span>
                <span class="p">)</span>

        <span class="c1"># add an extra space at the end of the event time, so we can hide</span>
        <span class="c1"># the &lt;br&gt; tag on the output without having the time and the</span>
        <span class="c1"># availability seemingly joined together without space.</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">event_time</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">available</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">event_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">&gt;=</span> <span class="mf">80.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;event-available&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">&gt;=</span> <span class="mf">20.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;event-partly-available&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;event-unavailable&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">event_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">is_manager</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Link</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Edit&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;edit&#39;</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="k">yield</span> <span class="n">Link</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Tickets&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">TicketCollection</span><span class="p">(</span>
                    <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                    <span class="n">handler</span><span class="o">=</span><span class="s1">&#39;RSV&#39;</span><span class="p">,</span>
                    <span class="n">state</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                    <span class="n">extra_parameters</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;allocation_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">)),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">==</span> <span class="mf">100.0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">DeleteLink</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Delete&quot;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="p">),</span>
                    <span class="n">confirm</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Do you really want to delete this allocation?&quot;</span><span class="p">),</span>
                    <span class="n">extra_information</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">event_identification</span><span class="p">,</span>
                    <span class="n">yes_button_text</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Delete allocation&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">DeleteLink</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Delete&quot;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="p">),</span>
                    <span class="n">confirm</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;This allocation can&#39;t be deleted because there are &quot;</span>
                        <span class="s2">&quot;existing reservations associated with it.&quot;</span>
                    <span class="p">),</span>
                    <span class="n">extra_information</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
                        <span class="s2">&quot;To delete this allocation, all existing reservations &quot;</span>
                        <span class="s2">&quot;need to be cancelled first.&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_start</span><span class="p">,</span>
            <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_end</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_title</span><span class="p">,</span>
            <span class="s1">&#39;wholeDay&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">whole_day</span><span class="p">,</span>
            <span class="s1">&#39;partlyAvailable&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">partly_available</span><span class="p">,</span>
            <span class="s1">&#39;quota&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">quota</span><span class="p">,</span>
            <span class="s1">&#39;quotaLeft&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quota_left</span><span class="p">,</span>
            <span class="s1">&#39;className&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_class</span><span class="p">,</span>
            <span class="s1">&#39;partitions&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="o">.</span><span class="n">availability_partitions</span><span class="p">(),</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_actions</span>
            <span class="p">],</span>
            <span class="s1">&#39;editurl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;edit&#39;</span><span class="p">),</span>
            <span class="s1">&#39;reserveurl&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;reserve&#39;</span><span class="p">)</span>
        <span class="p">}</span>


<span class="n">libres_error_messages</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">libres_errors</span><span class="o">.</span><span class="n">OverlappingAllocationError</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;A conflicting allocation exists for the requested time period.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">OverlappingReservationError</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;A conflicting reservation exists for the requested time period.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">AffectedReservationError</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;An existing reservation would be affected by the requested change.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">AffectedPendingReservationError</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;A pending reservation would be affected by the requested change.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">AlreadyReservedError</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The requested period is no longer available.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">NotReservableError</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No reservable slot found.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">ReservationTooLong</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Reservations can&#39;t be made for more than 24 hours at a time.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">ReservationParametersInvalid</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The given reservation paramters are invalid.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">InvalidReservationToken</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The given reservation token is invalid.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">InvalidReservationError</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The given reservation paramters are invalid.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">QuotaOverLimit</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The requested number of reservations is higher than allowed.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">InvalidQuota</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The requested quota is invalid (must be at least one).&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">QuotaImpossible</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The allocation does not have enough free spots.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">InvalidAllocationError</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The resulting allocation would be invalid.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">NoReservationsToConfirm</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;No reservations to confirm.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">TimerangeTooLong</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;The given timerange is longer than the existing allocation.&quot;</span><span class="p">),</span>

    <span class="n">libres_errors</span><span class="o">.</span><span class="n">ReservationTooShort</span><span class="p">:</span>
    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Reservation too short. A reservation must last at least 5 minutes.&quot;</span><span class="p">)</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">get_libres_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="n">libres_error_messages</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;Unknown libres error </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">libres_error_messages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>


<div class="viewcode-block" id="show_libres_error"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.utils.show_libres_error">[docs]</a><span class="k">def</span> <span class="nf">show_libres_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Shows a human readable error message for the given libres exception,</span>
<span class="sd">    using request.alert.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="n">get_libres_error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span></div>


<div class="viewcode-block" id="predict_next_daterange"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.utils.predict_next_daterange">[docs]</a><span class="k">def</span> <span class="nf">predict_next_daterange</span><span class="p">(</span><span class="n">dateranges</span><span class="p">,</span> <span class="n">min_probability</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Takes a list of dateranges (start, end) and tries to predict the next</span>
<span class="sd">    daterange in the list.</span>

<span class="sd">    See :func:`predict_next_value` for more information.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">predict_next_value</span><span class="p">(</span>
        <span class="n">values</span><span class="o">=</span><span class="n">dateranges</span><span class="p">,</span>
        <span class="n">min_probability</span><span class="o">=</span><span class="n">min_probability</span><span class="p">,</span>
        <span class="n">compute_delta</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">add_delta</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="predict_next_value"><a class="viewcode-back" href="../../../onegov_org.html#onegov.org.utils.predict_next_value">[docs]</a><span class="k">def</span> <span class="nf">predict_next_value</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">min_probability</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                       <span class="n">compute_delta</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span>
                       <span class="n">add_delta</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Takes a list of values and tries to predict the next value in the</span>
<span class="sd">    series.</span>

<span class="sd">    Meant to work on a small set of ranges (with first predictions</span>
<span class="sd">    appearing with only three values), this algorithm will look at all</span>
<span class="sd">    possible deltas between the values and keep track of the probability</span>
<span class="sd">    of delta y following delta x.</span>

<span class="sd">    If the delta between the second last and last value has a high</span>
<span class="sd">    probability of being followed by some delta p, then delta p is used to</span>
<span class="sd">    predict the next range.</span>

<span class="sd">    If the probability is too low (signified by min_probability), then None</span>
<span class="sd">    is returned.</span>

<span class="sd">    For large ranges better statistical models should be used. Here we are</span>
<span class="sd">    concerned with small series of data to answer the question &quot;if a user</span>
<span class="sd">    selected three values, what will his fourth be?&quot;</span>

<span class="sd">    If we for example know that the user selected 1, 2 and 3, then 4 is the</span>
<span class="sd">    next probable value in the series.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">deltas</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="n">previous</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">previous_delta</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">current</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">compute_delta</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">previous_delta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deltas</span><span class="p">[</span><span class="n">previous_delta</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>

        <span class="n">previous</span> <span class="o">=</span> <span class="n">current</span>
        <span class="n">previous_delta</span> <span class="o">=</span> <span class="n">delta</span>

    <span class="n">next_deltas</span> <span class="o">=</span> <span class="n">deltas</span><span class="p">[</span><span class="n">previous_delta</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">next_deltas</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">predicted_delta</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">next_deltas</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">probability</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_deltas</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">probability</span> <span class="o">&gt;=</span> <span class="n">min_probability</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">add_delta</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">predicted_delta</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=OneGov&repo=onegov-docs&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Verein OneGov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>
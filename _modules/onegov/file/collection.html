
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>onegov.file.collection &#8212; OneGov Docs 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for onegov.file.collection</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">depot.io.utils</span> <span class="k">import</span> <span class="n">file_from_content</span>
<span class="kn">from</span> <span class="nn">onegov.file.models</span> <span class="k">import</span> <span class="n">File</span><span class="p">,</span> <span class="n">FileSet</span>
<span class="kn">from</span> <span class="nn">onegov.file.utils</span> <span class="k">import</span> <span class="n">as_fileintent</span><span class="p">,</span> <span class="n">digest</span>
<span class="kn">from</span> <span class="nn">sedate</span> <span class="k">import</span> <span class="n">utcnow</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">or_</span>


<div class="viewcode-block" id="FileCollection"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection">[docs]</a><span class="k">class</span> <span class="nc">FileCollection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Manages files.</span>

<span class="sd">    :param session:</span>
<span class="sd">        The SQLAlchemy db session to use.</span>

<span class="sd">    :param type:</span>
<span class="sd">        The polymorphic type to use and to filter for, or &#39;*&#39; for all.</span>

<span class="sd">    :param allow_duplicates:</span>
<span class="sd">        Prevents duplicates if set to false. Duplicates are detected before</span>
<span class="sd">        pre-processing, so already stored files may be downloaded and</span>
<span class="sd">        added again, as they might have changed during the upload.</span>

<span class="sd">        Note that this does not change existing files. It only prevents</span>
<span class="sd">        new duplicates from being added.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">allow_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_duplicates</span> <span class="o">=</span> <span class="n">allow_duplicates</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">model_class</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">get_polymorphic_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">File</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">model_class</span> <span class="ow">is</span> <span class="n">File</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">File</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>

<div class="viewcode-block" id="FileCollection.add"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">publish_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a file with the given filename. The content maybe either</span>
<span class="sd">        in bytes or a file object.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_duplicates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_not_duplicate</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">get_polymorphic_class</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">File</span><span class="p">)()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">file</span><span class="o">.</span><span class="n">note</span> <span class="o">=</span> <span class="n">note</span>
        <span class="n">file</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">file</span><span class="o">.</span><span class="n">published</span> <span class="o">=</span> <span class="n">published</span>
        <span class="n">file</span><span class="o">.</span><span class="n">publish_date</span> <span class="o">=</span> <span class="n">publish_date</span>
        <span class="n">file</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">as_fileintent</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">file</span></div>

<div class="viewcode-block" id="FileCollection.replace"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Replaces the content of the given file with the new content. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_duplicates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assert_not_duplicate</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">as_fileintent</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">assert_not_duplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<div class="viewcode-block" id="FileCollection.publishable_files"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.publishable_files">[docs]</a>    <span class="k">def</span> <span class="nf">publishable_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Yields files which may be published. &quot;&quot;&quot;</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span>
            <span class="n">File</span><span class="o">.</span><span class="n">published</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">File</span><span class="o">.</span><span class="n">publish_date</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">File</span><span class="o">.</span><span class="n">publish_date</span> <span class="o">&lt;=</span> <span class="n">horizon</span>
        <span class="p">))</span></div>

<div class="viewcode-block" id="FileCollection.publish_files"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.publish_files">[docs]</a>    <span class="k">def</span> <span class="nf">publish_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Publishes unpublished files with a publish date older than the</span>
<span class="sd">        given horizon.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># default to a horizon slightly into the future as this method is</span>
        <span class="c1"># usually called by cronjob which is not perfectly on time</span>
        <span class="n">horizon</span> <span class="o">=</span> <span class="n">horizon</span> <span class="ow">or</span> <span class="p">(</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">90</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">publishable_files</span><span class="p">(</span><span class="n">horizon</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">published</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">f</span><span class="o">.</span><span class="n">publish_date</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileCollection.by_id"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.by_id">[docs]</a>    <span class="k">def</span> <span class="nf">by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the file with the given id or None. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">file_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div>

<div class="viewcode-block" id="FileCollection.by_filename"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.by_filename">[docs]</a>    <span class="k">def</span> <span class="nf">by_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a query that matches the files with the given filename.</span>

<span class="sd">        Be aware that there may be multiple files with the same filename!</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="FileCollection.by_checksum"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.by_checksum">[docs]</a>    <span class="k">def</span> <span class="nf">by_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checksum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a query that matches the given checksum (may be more than</span>
<span class="sd">        one record).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">checksum</span> <span class="o">==</span> <span class="n">checksum</span><span class="p">)</span></div>

<div class="viewcode-block" id="FileCollection.by_content"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.by_content">[docs]</a>    <span class="k">def</span> <span class="nf">by_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a query that matches the given content (may be more than</span>
<span class="sd">        one record).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">file_from_content</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="c1"># we need to look up two checksums, the one of the file stored and</span>
        <span class="c1"># possibly the one it had before signing</span>
        <span class="c1">#</span>
        <span class="c1"># XXX maybe it makes sense to combine those into a data structure</span>
        <span class="c1"># that holds all kinds of digests a file is known under</span>

        <span class="c1"># checksum</span>
        <span class="n">md5</span> <span class="o">=</span> <span class="n">digest</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;md5&#39;</span><span class="p">)</span>

        <span class="c1"># old_digest of signature_metadata</span>
        <span class="n">sha</span> <span class="o">=</span> <span class="n">digest</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span>
            <span class="n">File</span><span class="o">.</span><span class="n">checksum</span> <span class="o">==</span> <span class="n">md5</span><span class="p">,</span>
            <span class="n">File</span><span class="o">.</span><span class="n">signature_metadata</span><span class="p">[</span><span class="s1">&#39;old_digest&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span> <span class="o">==</span> <span class="n">sha</span>
        <span class="p">))</span></div>

<div class="viewcode-block" id="FileCollection.by_content_type"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.by_content_type">[docs]</a>    <span class="k">def</span> <span class="nf">by_content_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a query that matches the given MIME content type (may be</span>
<span class="sd">        more than one record).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;reference-&gt;&gt;&#39;content_type&#39; = :content_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span>
                <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FileCollection.by_signature_digest"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.by_signature_digest">[docs]</a>    <span class="k">def</span> <span class="nf">by_signature_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">digest</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a query that matches the given digest in the signature</span>
<span class="sd">        metadata. In other words, given a digest this function will find</span>
<span class="sd">        signed files that match the digest - either before or after signing.</span>

<span class="sd">        Unsigned files are ignored.</span>

<span class="sd">        The digest is expected to be a SHA256 hex.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">or_</span><span class="p">(</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;signature_metadata-&gt;&gt;&#39;old_digest&#39; = :digest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span>
                    <span class="n">digest</span><span class="o">=</span><span class="n">digest</span>
                <span class="p">),</span>
                <span class="n">text</span><span class="p">(</span><span class="s2">&quot;signature_metadata-&gt;&gt;&#39;new_digest&#39; = :digest&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span>
                    <span class="n">digest</span><span class="o">=</span><span class="n">digest</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="FileCollection.locate_signature_metadata"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileCollection.locate_signature_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">locate_signature_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">digest</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Looks for the given digest in the files table - if that doesn&#39;t</span>
<span class="sd">        work it will go through the audit trail (i.e. the chat messages) and</span>
<span class="sd">        see if the digest can be found there.</span>

<span class="sd">        If this database was ever used to sign a file with the given digest,</span>
<span class="sd">        or if a file that was signed had the given digest, this function</span>
<span class="sd">        will find it - barring manual database manipulation in the messages</span>
<span class="sd">        log.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_signature_digest</span><span class="p">(</span><span class="n">digest</span><span class="p">)</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span>
            <span class="n">File</span><span class="o">.</span><span class="n">signature_metadata</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">signature_metadata</span>

        <span class="kn">from</span> <span class="nn">onegov.chat</span> <span class="k">import</span> <span class="n">Message</span>  <span class="c1"># circular import</span>

        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Message</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;meta-&gt;&#39;action_metadata&#39;-&gt;&gt;&#39;old_digest&#39; = :digest&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span><span class="n">digest</span><span class="o">=</span><span class="n">digest</span><span class="p">),</span>
            <span class="n">text</span><span class="p">(</span>
                <span class="s2">&quot;meta-&gt;&#39;action_metadata&#39;-&gt;&gt;&#39;new_digest&#39; = :digest&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">bindparams</span><span class="p">(</span><span class="n">digest</span><span class="o">=</span><span class="n">digest</span><span class="p">)</span>
        <span class="p">))</span><span class="o">.</span><span class="n">with_entities</span><span class="p">(</span><span class="n">Message</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;action_metadata&#39;</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="FileSetCollection"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileSetCollection">[docs]</a><span class="k">class</span> <span class="nc">FileSetCollection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Manages filesets. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="n">model_class</span> <span class="o">=</span> <span class="n">FileSet</span><span class="o">.</span><span class="n">get_polymorphic_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">FileSet</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">model_class</span> <span class="ow">is</span> <span class="n">FileSet</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">File</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model_class</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FileSet</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="ow">or</span> <span class="kc">None</span>

        <span class="n">fileset</span> <span class="o">=</span> <span class="n">FileSet</span><span class="o">.</span><span class="n">get_polymorphic_class</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">FileSet</span><span class="p">)()</span>
        <span class="n">fileset</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="n">fileset</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="n">fileset</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="n">fileset</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fileset</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">fileset</span><span class="p">)</span>

<div class="viewcode-block" id="FileSetCollection.by_id"><a class="viewcode-back" href="../../../onegov_file.html#onegov.file.collection.FileSetCollection.by_id">[docs]</a>    <span class="k">def</span> <span class="nf">by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileset_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the fileset with the given id or None. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">FileSet</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fileset_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=OneGov&repo=onegov-docs&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Verein OneGov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>
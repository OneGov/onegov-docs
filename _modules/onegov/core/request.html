
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>onegov.core.request &#8212; OneGov Docs 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for onegov.core.request</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">morepath</span>

<span class="kn">from</span> <span class="nn">cached_property</span> <span class="k">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">onegov.core.cache</span> <span class="k">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BadSignature</span><span class="p">,</span>
    <span class="n">SignatureExpired</span><span class="p">,</span>
    <span class="n">TimestampSigner</span><span class="p">,</span>
    <span class="n">URLSafeSerializer</span><span class="p">,</span>
    <span class="n">URLSafeTimedSerializer</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">more.content_security</span> <span class="k">import</span> <span class="n">ContentSecurityRequest</span>
<span class="kn">from</span> <span class="nn">more.webassets.core</span> <span class="k">import</span> <span class="n">IncludeRequest</span>
<span class="kn">from</span> <span class="nn">morepath.authentication</span> <span class="k">import</span> <span class="n">NO_IDENTITY</span>
<span class="kn">from</span> <span class="nn">onegov.core</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">onegov.core.crypto</span> <span class="k">import</span> <span class="n">random_token</span>
<span class="kn">from</span> <span class="nn">webob.exc</span> <span class="k">import</span> <span class="n">HTTPForbidden</span>
<span class="kn">from</span> <span class="nn">wtforms.csrf.session</span> <span class="k">import</span> <span class="n">SessionCSRF</span>


<span class="n">Message</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Message&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="ReturnToMixin"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.ReturnToMixin">[docs]</a><span class="k">class</span> <span class="nc">ReturnToMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Provides a safe and convenient way of using return-to links.</span>

<span class="sd">    Return-to links are links with an added &#39;return-to&#39; query parameter</span>
<span class="sd">    which points to the url a specific view (usually with a form) should</span>
<span class="sd">    return to, once all is said and done.</span>

<span class="sd">    There&#39;s no magic involved. If a view should honor the return-to</span>
<span class="sd">    paramter, it should use request.redirect instead of morepath.redirect.</span>

<span class="sd">    If no return-to parameter was specified, rqeuest.redirect is a</span>
<span class="sd">    transparent proxy to morepath.redirect.</span>

<span class="sd">    To create a link::</span>

<span class="sd">        url = request.return_to(original_url, redirect)</span>

<span class="sd">    To honor the paramter in a view, if present::</span>

<span class="sd">        return request.redirect(default_url)</span>

<span class="sd">    *Do not use the return-to parameter directly*. Redirect parameters</span>
<span class="sd">    are notorious for being used in phising attacks. By using ``return_to``</span>
<span class="sd">    and ``redirect`` you are kept safe from these attacks as the redirect</span>
<span class="sd">    url is signed and verified.</span>

<span class="sd">    For the same reason you should not allow the user-data for return-to</span>
<span class="sd">    links. Those are meant for internally generated links!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">identity_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">redirect_signer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">URLSafeSerializer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_secret</span><span class="p">,</span> <span class="s1">&#39;return-to&#39;</span><span class="p">)</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sign_url_for_redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect_signer</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">return_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">redirect</span><span class="p">):</span>
        <span class="n">signed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_url_for_redirect</span><span class="p">(</span><span class="n">redirect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">append_query_param</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s1">&#39;return-to&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">return_here</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_to</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;return-to&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect_signer</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;return-to&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">BadSignature</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">morepath</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span></div>


<div class="viewcode-block" id="CoreRequest"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest">[docs]</a><span class="k">class</span> <span class="nc">CoreRequest</span><span class="p">(</span><span class="n">IncludeRequest</span><span class="p">,</span> <span class="n">ContentSecurityRequest</span><span class="p">,</span> <span class="n">ReturnToMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Extends the default Morepath request with virtual host support and</span>
<span class="sd">    other useful methods.</span>

<span class="sd">    Virtual hosting might be supported by Morepath directly in the future:</span>
<span class="sd">    https://github.com/morepath/morepath/issues/185</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">identity_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">identity_secret</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>

<div class="viewcode-block" id="CoreRequest.link_prefix"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.link_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">link_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Override the `link_prefix` with the application base path provided</span>
<span class="sd">        by onegov.server, because the default link_prefix contains the</span>
<span class="sd">        hostname, which is not useful in our case - we&#39;ll add the hostname</span>
<span class="sd">        ourselves later.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="s1">&#39;application_base_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">x_vhm_host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the X_VHM_HOST variable or an empty string.</span>

<span class="sd">        X_VHM_HOST acts like a prefix to all links generated by Morepath.</span>
<span class="sd">        If this variable is not empty, it will be added in front of all</span>
<span class="sd">        generated urls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X_VHM_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">x_vhm_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the X_VHM_ROOT variable or an empty string.</span>

<span class="sd">        X_VHM_ROOT is a bit more tricky than X_VHM_HOST. It tells Morepath</span>
<span class="sd">        where the root of the application is situated. This means that the</span>
<span class="sd">        value of X_VHM_ROOT must be an existing path inside of Morepath.</span>

<span class="sd">        We can understand this best with an example. Let&#39;s say you have a</span>
<span class="sd">        Morepath application that serves a blog under /blog. You now want to</span>
<span class="sd">        serve the blog under a separate domain, say blog.example.org.</span>

<span class="sd">        If we just served Morepath under blog.example.org, we&#39;d get urls like</span>
<span class="sd">        this one::</span>

<span class="sd">            blog.example.org/blog/posts/2014-11-17-16:00</span>

<span class="sd">        In effect, this subdomain would be no different from example.org</span>
<span class="sd">        (without the blog subdomain). However, we want the root of the host to</span>
<span class="sd">        point to /blog.</span>

<span class="sd">        To do this we set X_VHM_ROOT to /blog. Morepath will then automatically</span>
<span class="sd">        return urls like this::</span>

<span class="sd">            blog.example.org/posts/2014-11-17-16:00</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X_VHM_ROOT&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the current url, taking the virtual hosting in account. &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_string</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_string</span>

        <span class="k">return</span> <span class="n">url</span>

<div class="viewcode-block" id="CoreRequest.transform"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Applies X_VHM_HOST and X_VHM_ROOT to the given url (which is</span>
<span class="sd">        expected to not contain a host yet!). &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vhm_root</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">lchop</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vhm_root</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vhm_host</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_vhm_host</span> <span class="o">+</span> <span class="n">url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host_url</span> <span class="o">+</span> <span class="n">url</span>

        <span class="k">return</span> <span class="n">url</span></div>

<div class="viewcode-block" id="CoreRequest.link"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.link">[docs]</a>    <span class="k">def</span> <span class="nf">link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extends the default link generating function of Morepath. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="CoreRequest.class_link"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.class_link">[docs]</a>    <span class="k">def</span> <span class="nf">class_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extends the default class link generating function of Morepath. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">class_link</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span></div>

<div class="viewcode-block" id="CoreRequest.filestorage_link"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.filestorage_link">[docs]</a>    <span class="k">def</span> <span class="nf">filestorage_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Takes the given filestorage path and returns an url if the path</span>
<span class="sd">        exists. The url might point to the local server or it might point to</span>
<span class="sd">        somehwere else on the web.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">filestorage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">filestorage</span><span class="o">.</span><span class="n">hasurl</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">filestorage</span><span class="o">.</span><span class="n">geturl</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">url</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">filestorage</span><span class="o">.</span><span class="n">FilestorageFile</span><span class="p">(</span><span class="n">path</span><span class="p">))</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">theme_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the link to the current theme. Computed once per request.</span>

<span class="sd">        The theme is automatically compiled and stored if it doesn&#39;t exist yet,</span>
<span class="sd">        or if it is outdated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">theme</span>
        <span class="k">assert</span> <span class="n">theme</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Do not call if no theme is used&quot;</span>

        <span class="n">force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">always_compile_theme</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">allow_shift_f5_compile</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache-control&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;no-cache&#39;</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x-requested-with&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;XMLHttpRequest&#39;</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">themestorage</span><span class="p">,</span> <span class="n">theme</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">theme_options</span><span class="p">,</span>
            <span class="n">force</span><span class="o">=</span><span class="n">force</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">theme</span><span class="o">.</span><span class="n">ThemeFile</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">browser_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a browser_session bound to the request. Works via cookies,</span>
<span class="sd">        so requests without cookies won&#39;t be able to use the browser_session.</span>

<span class="sd">        The browser session is bound to the application (by id), so no session</span>
<span class="sd">        data is shared between the applications.</span>

<span class="sd">        If no data is written to the browser_session, no session_id cookie</span>
<span class="sd">        is created.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;session_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unsign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">])</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span> <span class="ow">or</span> <span class="n">random_token</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">random_token</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">on_dirty</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
                <span class="nd">@self</span><span class="o">.</span><span class="n">after</span>
                <span class="k">def</span> <span class="nf">delete_session</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

                <span class="nd">@self</span><span class="o">.</span><span class="n">after</span>
                <span class="k">def</span> <span class="nf">store_session</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
                        <span class="s1">&#39;session_id&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">],</span>
                        <span class="n">secure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">identity_secure</span><span class="p">,</span>
                        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">samesite</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">same_site_cookie_policy</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">browser_session</span><span class="o">.</span><span class="n">BrowserSession</span><span class="p">(</span>
            <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">session_cache</span><span class="p">,</span>
            <span class="n">token</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span>
            <span class="n">on_dirty</span><span class="o">=</span><span class="n">on_dirty</span>
        <span class="p">)</span>

<div class="viewcode-block" id="CoreRequest.get_form"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.get_form">[docs]</a>    <span class="k">def</span> <span class="nf">get_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form_class</span><span class="p">,</span> <span class="n">i18n_support</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">csrf_support</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns an instance of the given form class, set up with the</span>
<span class="sd">        correct translator and with CSRF protection enabled (the latter</span>
<span class="sd">        doesn&#39;t work yet).</span>

<span class="sd">        Form classes passed to this function (or defined through the</span>
<span class="sd">        ``App.form`` directive) may define a ``on_request`` method, which</span>
<span class="sd">        is called after the request has been bound to the form and before</span>
<span class="sd">        the view function is called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">i18n_support</span><span class="p">:</span>
            <span class="n">translate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_translate</span><span class="p">(</span><span class="n">for_chameleon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">form_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">i18n</span><span class="o">.</span><span class="n">get_translation_bound_form</span><span class="p">(</span>
                <span class="n">form_class</span><span class="p">,</span> <span class="n">translate</span><span class="p">)</span>

            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;locales&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">,</span> <span class="s1">&#39;en&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">csrf_support</span><span class="p">:</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;csrf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;csrf_context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_session</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;csrf_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SessionCSRF</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;csrf_secret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">csrf_secret</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;csrf_time_limit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span>
                <span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">csrf_time_limit</span><span class="p">)</span>

        <span class="c1"># XXX it might be cleaner to always use the request in the meta,</span>
        <span class="c1"># instead of adding it to the form like it is done below - the meta</span>
        <span class="c1"># can also be accessed by form widgets</span>
        <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">formdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">POST</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">POST</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">form_class</span><span class="p">(</span><span class="n">formdata</span><span class="o">=</span><span class="n">formdata</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="s1">&#39;request&#39;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">form</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="s1">&#39;on_request&#39;</span><span class="p">):</span>
            <span class="n">form</span><span class="o">.</span><span class="n">on_request</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">form</span></div>

<div class="viewcode-block" id="CoreRequest.translate"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.translate">[docs]</a>    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Transalates the given text, if it&#39;s a translatable text. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;domain&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">text</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">translator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the translate function for basic string translations. &quot;&quot;&quot;</span>
        <span class="n">translator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_translate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">translator</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="n">text</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">translator</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>

        <span class="k">return</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="n">text</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">default_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the default locale. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">default_locale</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">locale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the current locale of this request. &quot;&quot;&quot;</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">settings</span>

        <span class="n">locale</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">i18n</span><span class="o">.</span><span class="n">locale_negotiator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">locales</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">locale</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">default_locale</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">html_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The language code for the html tag. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>

<div class="viewcode-block" id="CoreRequest.get_translate"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.get_translate">[docs]</a>    <span class="k">def</span> <span class="nf">get_translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_chameleon</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the translate method to the given request, or None</span>
<span class="sd">        if no such method is availabe.</span>

<span class="sd">        :for_chameleon:</span>
<span class="sd">            True if the translate instance is used for chameleon (which is</span>
<span class="sd">            special).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">locales</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">for_chameleon</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">chameleon_translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">translations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.message"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.message">[docs]</a>    <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a message with the given type to the messages list. This</span>
<span class="sd">        messages list may then be displayed by an application building on</span>
<span class="sd">        onegov.core.</span>

<span class="sd">        For example:</span>

<span class="sd">            http://foundation.zurb.com/docs/components/alert_boxes.html</span>

<span class="sd">        Four default types are defined on the request for easier use:</span>

<span class="sd">        :meth:`success`</span>
<span class="sd">        :meth:`warning`</span>
<span class="sd">        :meth:`info`</span>
<span class="sd">        :meth:`alert`</span>

<span class="sd">        The messages are stored with the session and to display them, the</span>
<span class="sd">        template using the messages should call :meth:`consume_messages`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_session</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browser_session</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">Message</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">type</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this is a bit akward, but I don&#39;t see an easy way for this atm.</span>
            <span class="c1"># (otoh, usually there&#39;s going to be one message only)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browser_session</span><span class="o">.</span><span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_session</span><span class="o">.</span><span class="n">messages</span> <span class="o">+</span> <span class="p">[</span>
                <span class="n">Message</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="p">]</span></div>

<div class="viewcode-block" id="CoreRequest.consume_messages"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.consume_messages">[docs]</a>    <span class="k">def</span> <span class="nf">consume_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the messages, removing them from the session in the</span>
<span class="sd">        process. Call only if you can be reasonably sure that the user</span>
<span class="sd">        will see the messages.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">,</span> <span class="p">())</span></div>

<div class="viewcode-block" id="CoreRequest.success"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.success">[docs]</a>    <span class="k">def</span> <span class="nf">success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a success message. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.warning"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.warning">[docs]</a>    <span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds a warning message. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;warning&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.info"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds an info message. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.alert"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.alert">[docs]</a>    <span class="k">def</span> <span class="nf">alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds an alert message. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;alert&#39;</span><span class="p">)</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">is_logged_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if the current request is logged in at all. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NO_IDENTITY</span>

<div class="viewcode-block" id="CoreRequest.has_permission"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.has_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if the current user has the given permission on the</span>
<span class="sd">        given model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">permission</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">_permits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">permission</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.has_access_to_url"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.has_access_to_url">[docs]</a>    <span class="k">def</span> <span class="nf">has_access_to_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns true if the current user has access to the given url.</span>

<span class="sd">        The domain part of the url is completely ignored. This method should</span>
<span class="sd">        only be used if you have no other choice. Loading the object by</span>
<span class="sd">        url first is slower than if you can get the object otherwise.</span>

<span class="sd">        The initial use-case for this function is the to parameter in the</span>
<span class="sd">        login view. If the to-url is accessible anyway, we skip the login</span>
<span class="sd">        view.</span>

<span class="sd">        If we can&#39;t find a view for the url, a KeyError is thrown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span><span class="p">,</span> <span class="n">view_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">object_by_path</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">with_view_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Could not find view for &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>

        <span class="n">permission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">permission_by_view</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">view_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">permission</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.exclude_invisible"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.exclude_invisible">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_invisible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">models</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Excludes models invisble to the current user from the list. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_visible</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span></div>

<div class="viewcode-block" id="CoreRequest.is_visible"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.is_visible">[docs]</a>    <span class="k">def</span> <span class="nf">is_visible</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if the given model is visible to the current user.</span>
<span class="sd">        This is basically an alias for :meth:`CoreRequest.is_public`. It exists</span>
<span class="sd">        because it is easier to understand than ``is_public``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">Public</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.is_public"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.is_public">[docs]</a>    <span class="k">def</span> <span class="nf">is_public</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if the current user has the Public permission for</span>
<span class="sd">        the given model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">Public</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.is_personal"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.is_personal">[docs]</a>    <span class="k">def</span> <span class="nf">is_personal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if the current user has the Personal permission for</span>
<span class="sd">        the given model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">Personal</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.is_private"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.is_private">[docs]</a>    <span class="k">def</span> <span class="nf">is_private</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if the current user has the Private permission for</span>
<span class="sd">        the given model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">Private</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.is_secret"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.is_secret">[docs]</a>    <span class="k">def</span> <span class="nf">is_secret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns True if the current user has the Secret permission for</span>
<span class="sd">        the given model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">security</span><span class="o">.</span><span class="n">Secret</span><span class="p">)</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">current_role</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the user-role of the current request, if logged in.</span>
<span class="sd">        Otherwise, None is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">role</span> <span class="ow">or</span> <span class="kc">None</span>

<div class="viewcode-block" id="CoreRequest.has_role"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.has_role">[docs]</a>    <span class="k">def</span> <span class="nf">has_role</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">roles</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns true if the current user has any of the given roles. &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">roles</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">roles</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_role</span> <span class="ow">in</span> <span class="n">roles</span></div>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">csrf_salt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_session</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="s1">&#39;csrf_salt&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">browser_session</span><span class="p">[</span><span class="s1">&#39;csrf_salt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_token</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browser_session</span><span class="p">[</span><span class="s1">&#39;csrf_salt&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="CoreRequest.new_csrf_token"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.new_csrf_token">[docs]</a>    <span class="k">def</span> <span class="nf">new_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a new CSRF token. A CSRF token can be verified</span>
<span class="sd">        using :meth:`is_valid_csrf_token`.</span>

<span class="sd">        Note that forms do their own CSRF protection. This is meant</span>
<span class="sd">        for CSRF protection outside of forms.</span>

<span class="sd">        onegov.core uses the Synchronizer Token Pattern for CSRF protection:</span>
<span class="sd">        `&lt;https://www.owasp.org/index.php/\</span>
<span class="sd">        Cross-Site_Request_Forgery_%28CSRF%29_Prevention_Cheat_Sheet&gt;`_</span>

<span class="sd">        New CSRF tokens are signed usign a secret attached to the session (but</span>
<span class="sd">        not sent out to the user). Clients have to return the CSRF token they</span>
<span class="sd">        are given. The token has to match the secret, which the client doesn&#39;t</span>
<span class="sd">        know. So an attacker would have to get access to both the cookie and</span>
<span class="sd">        the html source to be able to forge a request.</span>

<span class="sd">        Since cookies are marked as HTTP only (no javascript access), this</span>
<span class="sd">        even prevents CSRF attack combined with XSS.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># no csrf tokens for anonymous users (there&#39;s not really a point</span>
        <span class="c1"># to doing this)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="k">assert</span> <span class="n">salt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">csrf_salt</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="n">salt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">csrf_salt</span>

        <span class="c1"># use app.identity_secret here, because that&#39;s being used for</span>
        <span class="c1"># more.itsdangerous, which uses the same algorithm</span>
        <span class="n">signer</span> <span class="o">=</span> <span class="n">TimestampSigner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_secret</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">signer</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">random_token</span><span class="p">())</span></div>

<div class="viewcode-block" id="CoreRequest.assert_valid_csrf_token"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.assert_valid_csrf_token">[docs]</a>    <span class="k">def</span> <span class="nf">assert_valid_csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signed_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Validates the given CSRF token and returns if it was</span>
<span class="sd">        created by :meth:`new_csrf_token`. If there&#39;s a mismatch, a 403 is</span>
<span class="sd">        raised.</span>

<span class="sd">        If no signed_value is passed, it is taken from</span>
<span class="sd">        request.params.get(&#39;csrf-token&#39;).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">signed_value</span> <span class="o">=</span> <span class="n">signed_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csrf-token&#39;</span><span class="p">)</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="n">salt</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">csrf_salt</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">signed_value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPForbidden</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">salt</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPForbidden</span><span class="p">()</span>

        <span class="n">signer</span> <span class="o">=</span> <span class="n">TimestampSigner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_secret</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signer</span><span class="o">.</span><span class="n">unsign</span><span class="p">(</span><span class="n">signed_value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">csrf_time_limit</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">SignatureExpired</span><span class="p">,</span> <span class="n">BadSignature</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">HTTPForbidden</span><span class="p">()</span></div>

<div class="viewcode-block" id="CoreRequest.new_url_safe_token"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.new_url_safe_token">[docs]</a>    <span class="k">def</span> <span class="nf">new_url_safe_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a new URL safe token. A token can be deserialized</span>
<span class="sd">        using :meth:`load_url_safe_token`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_secret</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoreRequest.load_url_safe_token"><a class="viewcode-back" href="../../../onegov_core.html#onegov.core.framework.CoreRequest.load_url_safe_token">[docs]</a>    <span class="k">def</span> <span class="nf">load_url_safe_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deserialize a token created by :meth:`new_url_safe_token`.</span>

<span class="sd">        If the token is invalid, None is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identity_secret</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">serializer</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="n">max_age</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">SignatureExpired</span><span class="p">,</span> <span class="n">BadSignature</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=OneGov&repo=onegov-docs&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Verein OneGov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>
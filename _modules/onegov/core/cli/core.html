
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>onegov.core.cli.core &#8212; OneGov Docs 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for onegov.core.cli.core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. _core-commands:</span>

<span class="sd">Core Commands</span>
<span class="sd">-------------</span>

<span class="sd">Provides a framework for cli commands run against one ore more onegov</span>
<span class="sd">cloud applications.</span>

<span class="sd">OneGov cli commands are usually ran against a onegov.yml config file, which</span>
<span class="sd">may contain definitions for multiple applications. It may define multiple</span>
<span class="sd">application with different applicaiton classes and it may contain wildcard</span>
<span class="sd">applications which run the same application class, but contain multiple</span>
<span class="sd">tennants for each application.</span>

<span class="sd">To have a command run against one or many applications we use a selector to</span>
<span class="sd">help select the applications we want to target in a command.</span>

<span class="sd">In addition to selectors, onegov core cli commands provide a simple way to</span>
<span class="sd">write a function that takes a request and an application. This function is</span>
<span class="sd">then called for each application matching the selector, with a proper</span>
<span class="sd">request and application context already setup (with the same characteristics</span>
<span class="sd">as if called through an url in the browser).</span>

<span class="sd">Selector</span>
<span class="sd">--------</span>

<span class="sd">A selector has the form &lt;namespace&gt;/&lt;id&gt;.</span>

<span class="sd">That is, it consists of the namespace of the application and it&#39;s id.</span>

<span class="sd">For example:</span>

<span class="sd">    * ``/foo/bar``</span>
<span class="sd">    * ``/onegov_election_day/gr``</span>
<span class="sd">    * ``/onegov_town/govikon``</span>

<span class="sd">To select non-wildcard applications we can just omit the id:</span>

<span class="sd">    * ``/foo``</span>
<span class="sd">    * ``/onegov_onboarding``</span>

<span class="sd">Finally, to select multiple applications we can use wildcards:</span>

<span class="sd">    * ``/foo/*``</span>
<span class="sd">    * ``/onegov_election_day/*``</span>
<span class="sd">    * ``/*/g??``</span>

<span class="sd">Execution</span>
<span class="sd">---------</span>

<span class="sd">To run a supported command we provide a selector as an option::</span>

<span class="sd">    bin/onegov-core --select &#39;/foo/*&#39; subcommand</span>

<span class="sd">To find out what kind of selectors are available, we can simply run::</span>

<span class="sd">    bin/onegov-core</span>

<span class="sd">Which will print out a list of selector suggestions.</span>

<span class="sd">Registering a Selector Based Command</span>
<span class="sd">------------------------------------</span>

<span class="sd">To write a selector based command we first create a command group::</span>

<span class="sd">    from onegov.core.cli import command_group</span>
<span class="sd">    cli = command_group()</span>

<span class="sd">Using that command group, we can register our own commands::</span>

<span class="sd">    @cli.command()</span>
<span class="sd">    def my_click_command():</span>
<span class="sd">        pass</span>

<span class="sd">This command works like any other click command::</span>

<span class="sd">    import click</span>

<span class="sd">    @cli.command()</span>
<span class="sd">    @click.option(&#39;--option&#39;)</span>
<span class="sd">    def my_click_command(option):</span>
<span class="sd">        pass</span>

<span class="sd">Each command has the ability to influence the way selectors work. For example,</span>
<span class="sd">a command which creates the path that matches the selector we can use::</span>

<span class="sd">    @cli.command(context_settings={&#39;creates_path&#39;: True})</span>

<span class="sd">By default we expect that a selector is passed. For commands which usually run</span>
<span class="sd">against all applications we can provide a default selector::</span>

<span class="sd">    @cli.command(context_settings={&#39;default_selector&#39;: &#39;*&#39;})</span>

<span class="sd">Using the app/request context</span>
<span class="sd">-----------------------------</span>

<span class="sd">For a lot of commands the easiest approach is to have a function which is</span>
<span class="sd">called for each application with a request. This allows us to write commands</span>
<span class="sd">which behave like they were written in a view.</span>

<span class="sd">To do that we register a command which returns a function with the following</span>
<span class="sd">signature::</span>

<span class="sd">    def handle_command(request, app):</span>
<span class="sd">        pass</span>

<span class="sd">For example::</span>

<span class="sd">    @cli.command()</span>
<span class="sd">    def my_click_command():</span>

<span class="sd">        def handle_command(request, app):</span>
<span class="sd">            pass</span>

<span class="sd">        return handle_command</span>

<span class="sd">Setup like this, ``handle_command`` will be called with a request for each</span>
<span class="sd">application (and tennant). This function acts exactly like a view. Most</span>
<span class="sd">importantly, it does *not* require transaction commits, because like with</span>
<span class="sd">ordinary requests, the transaction is automatically committed if no error</span>
<span class="sd">occurs.</span>

<span class="sd">Using the app configurations directly</span>
<span class="sd">-------------------------------------</span>

<span class="sd">Sometimes we don&#39;t want to use the request/app context, or maybe we want to</span>
<span class="sd">setup something before receiving a request.</span>

<span class="sd">To do this, we use the ``pass_group_context`` decorator.</span>

<span class="sd">For example::</span>

<span class="sd">    from onegov.core.cli import pass_group_context</span>

<span class="sd">    @cli.command()</span>
<span class="sd">    @pass_group_context</span>
<span class="sd">    def my_click_command(group_context):</span>

<span class="sd">        for appcfg in group_context.appcfgs:</span>
<span class="sd">            # do something</span>

<span class="sd">This is independent of the app/request context. If we return a function, the</span>
<span class="sd">function is going to be called with the request and the app. If we do not, the</span>
<span class="sd">command ends as expected.</span>

<span class="sd">Returning multiple functions</span>
<span class="sd">----------------------------</span>

<span class="sd">When a cli command returns multiple functions, they are run in succession.</span>

<span class="sd">The signature is taken into account. If there&#39;s a &#39;request&#39; parameter in the</span>
<span class="sd">function, the usual request context is set up.</span>

<span class="sd">If there is no &#39;request&#39; parameter in the function, it is called once per</span>
<span class="sd">appcfg, together with the group context::</span>

<span class="sd">    @cli.command()</span>
<span class="sd">    def my_special_command():</span>

<span class="sd">        def handle_command(request, app):</span>
<span class="sd">            pass</span>

<span class="sd">        def handle_raw(group_context, appcfg):</span>
<span class="sd">            pass</span>

<span class="sd">        return (handle_command, handle_raw)</span>

<span class="sd">Limiting Selectors to a Single Instance</span>
<span class="sd">---------------------------------------</span>

<span class="sd">Sometimes we want to write commands which only run against a single</span>
<span class="sd">application. A good example is a command which returns 1/0 depending on the</span>
<span class="sd">existence of something *in* an application.</span>

<span class="sd">To do that, we use::</span>

<span class="sd">    @cli.command(context_settings={&#39;singular&#39;: True})</span>
<span class="sd">    def my_click_command():</span>
<span class="sd">        pass</span>

<span class="sd">If a selector is passed which matches more than one application, the command</span>
<span class="sd">is not executed.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">fnmatch</span> <span class="k">import</span> <span class="n">fnmatch</span>
<span class="kn">from</span> <span class="nn">onegov.core.security</span> <span class="k">import</span> <span class="n">Public</span>
<span class="kn">from</span> <span class="nn">onegov.core.utils</span> <span class="k">import</span> <span class="n">scan_morepath_modules</span>
<span class="kn">from</span> <span class="nn">onegov.core.orm</span> <span class="k">import</span> <span class="n">query_schemas</span><span class="p">,</span> <span class="n">DB_CONNECTION_ERRORS</span>
<span class="kn">from</span> <span class="nn">onegov.server.config</span> <span class="k">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">onegov.server.core</span> <span class="k">import</span> <span class="n">Server</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="k">import</span> <span class="n">NullPool</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="k">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">webtest</span> <span class="k">import</span> <span class="n">TestApp</span> <span class="k">as</span> <span class="n">Client</span>


<span class="c1">#: :class:`GroupContext` settings which may be overriden by commands</span>
<span class="n">CONTEXT_SPECIFIC_SETTINGS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;default_selector&#39;</span><span class="p">,</span>
    <span class="s1">&#39;creates_path&#39;</span><span class="p">,</span>
    <span class="s1">&#39;singular&#39;</span><span class="p">,</span>
    <span class="s1">&#39;matches_required&#39;</span>
<span class="p">)</span>


<div class="viewcode-block" id="GroupContextGuard"><a class="viewcode-back" href="../../../../onegov_core.html#onegov.core.cli.core.GroupContextGuard">[docs]</a><span class="k">class</span> <span class="nc">GroupContextGuard</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Contains methods which abort the commandline program if any condition</span>
<span class="sd">    is not met.</span>

<span class="sd">    Used as a mixin in :class:`GroupContext`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">validate_guard_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">click_context</span><span class="p">):</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;abort&#39;</span><span class="p">):</span>
                <span class="n">method</span><span class="p">(</span><span class="n">click_context</span><span class="p">,</span> <span class="n">matches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">abort_if_no_selector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">click_context</span><span class="p">,</span> <span class="n">matches</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot;Available selectors:&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">selector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_selectors</span><span class="p">:</span>
                <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot; - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selector</span><span class="p">))</span>

            <span class="n">abort</span><span class="p">(</span><span class="s2">&quot;No selector provided, aborting.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">abort_if_no_subcommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">click_context</span><span class="p">,</span> <span class="n">matches</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">click_context</span><span class="o">.</span><span class="n">invoked_subcommand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot;Paths matching the selector:&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot; - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match</span><span class="p">))</span>

            <span class="n">abort</span><span class="p">(</span><span class="s2">&quot;No subcommand provided, aborting.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">abort_if_no_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">click_context</span><span class="p">,</span> <span class="n">matches</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches_required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot;Available selectors:&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">selector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_selectors</span><span class="p">:</span>
                <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot; - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selector</span><span class="p">))</span>

            <span class="n">abort</span><span class="p">(</span><span class="s2">&quot;Selector doesn&#39;t match any paths, aborting.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">abort_if_not_singular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">click_context</span><span class="p">,</span> <span class="n">matches</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">singular</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot;Paths matching the selector:&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="s2">&quot; - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match</span><span class="p">))</span>

            <span class="n">abort</span><span class="p">(</span><span class="s2">&quot;The selector must match a single path, aborting.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">abort_if_no_create_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">click_context</span><span class="p">,</span> <span class="n">matches</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">creates_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">abort</span><span class="p">(</span><span class="s2">&quot;This selector may not reference an existing path&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">abort</span><span class="p">(</span><span class="s2">&quot;This selector must reference a full path&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="p">:</span>
                <span class="n">abort</span><span class="p">(</span><span class="s2">&quot;This selector may not contain a wildcard&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GroupContext"><a class="viewcode-back" href="../../../../onegov_core.html#onegov.core.cli.core.GroupContext">[docs]</a><span class="k">class</span> <span class="nc">GroupContext</span><span class="p">(</span><span class="n">GroupContextGuard</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Provides access to application configs for group commands.</span>

<span class="sd">    :param selector:</span>
<span class="sd">        Selects the applications which should be captured by a</span>
<span class="sd">        :func:`command_group`.</span>

<span class="sd">        See :ref:`core-commands` for more documentation about</span>
<span class="sd">        selectors.</span>

<span class="sd">    :param config:</span>
<span class="sd">        The targeted onegov.yml file or an equivalent dictionary.</span>

<span class="sd">    :param default_selector:</span>
<span class="sd">        The selector used if none is provided. If not given, a selector</span>
<span class="sd">        *has* to be provided.</span>

<span class="sd">    :param creates_path:</span>
<span class="sd">        True if the given selector doesn&#39;t exist yet, but will be created.</span>
<span class="sd">        Commands which use this setting are expected to take a single path</span>
<span class="sd">        (no wildcards) and to create it during their runtime.</span>

<span class="sd">        Implies `singular` and `matches_required`.</span>

<span class="sd">    :param singular:</span>
<span class="sd">        True if the selector may not match multiple applications.</span>

<span class="sd">    :param matches_required:</span>
<span class="sd">        True if the selector *must* match at least one application.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">default_selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">creates_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">singular</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">matches_required</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">from_yaml_file</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span> <span class="ow">or</span> <span class="n">default_selector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creates_path</span> <span class="o">=</span> <span class="n">creates_path</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">creates_path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">singular</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matches_required</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">singular</span> <span class="o">=</span> <span class="n">singular</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">matches_required</span> <span class="o">=</span> <span class="n">matches_required</span>

<div class="viewcode-block" id="GroupContext.available_schemas"><a class="viewcode-back" href="../../../../onegov_core.html#onegov.core.cli.core.GroupContext.available_schemas">[docs]</a>    <span class="k">def</span> <span class="nf">available_schemas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appcfg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns all available schemas, if the application is database</span>
<span class="sd">        bound.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;dsn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">configuration</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># creating your engine should usually be avoided, be sure to only</span>
        <span class="c1"># copy this code when you don&#39;t need the typical session manager</span>
        <span class="c1"># engine setup</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">appcfg</span><span class="o">.</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;dsn&#39;</span><span class="p">],</span> <span class="n">poolclass</span><span class="o">=</span><span class="n">NullPool</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">query_schemas</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">appcfg</span><span class="o">.</span><span class="n">namespace</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">split_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

<div class="viewcode-block" id="GroupContext.match_to_path"><a class="viewcode-back" href="../../../../onegov_core.html#onegov.core.cli.core.GroupContext.match_to_path">[docs]</a>    <span class="k">def</span> <span class="nf">match_to_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Takes the given match and returns the application path used in</span>
<span class="sd">        http requests.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">namespace</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_match</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">appcfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">applications</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">namespace</span> <span class="o">==</span> <span class="n">namespace</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupContext.match_to_appcfg"><a class="viewcode-back" href="../../../../onegov_core.html#onegov.core.cli.core.GroupContext.match_to_appcfg">[docs]</a>    <span class="k">def</span> <span class="nf">match_to_appcfg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Takes the given match and returns the maching appcfg object. &quot;&quot;&quot;</span>

        <span class="n">namespace</span><span class="p">,</span> <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_match</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">appcfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">applications</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">namespace</span> <span class="o">==</span> <span class="n">namespace</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">appcfg</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">appcfgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the matching appconfigs.</span>

<span class="sd">        Since there&#39;s only one appconfig per namespace, we ignore the path</span>
<span class="sd">        part of the selector and only focus on the namespace::</span>

<span class="sd">            /namespace/application_id</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">namespace_selector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">appcfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">applications</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">appcfg</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">namespace_selector</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">appcfg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">available_selectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a list of available selectors.</span>

<span class="sd">        The list doesn&#39;t technically exhaust all options, but it returns</span>
<span class="sd">        all selectors targeting a single application as well as all selectors</span>
<span class="sd">        targeting a namespace by wildcard.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selectors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_wildcard_selectors</span><span class="p">)</span>
        <span class="n">selectors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_specific_selectors</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">selectors</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_wildcard_selectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns all selectors targeting a namespace by wildcard. &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">appcfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">applications</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">namespace</span> <span class="o">+</span> <span class="s1">&#39;/*&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_specific_selectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns all selectors targeting an application directly. &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">appcfg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">applications</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="k">yield</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">namespace</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_schemas</span><span class="p">(</span><span class="n">appcfg</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">schema</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the specific selectors matching the context selector.</span>

<span class="sd">        That is, a combination of namespace / application id is returned.</span>
<span class="sd">        Since we only know an exhaustive list of application id&#39;s *if* we have</span>
<span class="sd">        a database connection this is currently limited to applications with</span>
<span class="sd">        one. Since we do not have any others yet that&#39;s fine.</span>

<span class="sd">        However if we implement a database-less application in the future which</span>
<span class="sd">        takes wildcard ids, we need some way to enumerate those ids.</span>

<span class="sd">        See https://github.com/OneGov/onegov.core/issues/13</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">selector</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_specific_selectors</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">selector</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">creates_path</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_context_specific_settings"><a class="viewcode-back" href="../../../../onegov_core.html#onegov.core.cli.core.get_context_specific_settings">[docs]</a><span class="k">def</span> <span class="nf">get_context_specific_settings</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Takes the given *click* context and extracts all context specific</span>
<span class="sd">    settings from it.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">invoked_subcommand</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="c1"># The context settings are stored on the command though they are actually</span>
    <span class="c1"># click&#39;s settings, not ours. Upon inspection we need to transfer them</span>
    <span class="c1"># here as a result. It&#39;s basically a piggy back ride.</span>
    <span class="n">subcommand</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">invoked_subcommand</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subcommand</span><span class="p">,</span> <span class="s1">&#39;onegov_settings&#39;</span><span class="p">):</span>
        <span class="n">subcommand</span><span class="o">.</span><span class="n">onegov_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">subcommand</span><span class="o">.</span><span class="n">context_settings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">CONTEXT_SPECIFIC_SETTINGS</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">subcommand</span><span class="o">.</span><span class="n">context_settings</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">subcommand</span><span class="o">.</span><span class="n">onegov_settings</span></div>


<span class="c1">#: Decorator to acquire the group context on a command::</span>
<span class="c1">#:</span>
<span class="c1">#:     @cli.command()</span>
<span class="c1">#:     @pass_group_context()</span>
<span class="c1">#:     def my_command(group_context):</span>
<span class="c1">#:         pass</span>
<span class="c1">#:</span>
<span class="n">pass_group_context</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">make_pass_decorator</span><span class="p">(</span><span class="n">GroupContext</span><span class="p">,</span> <span class="n">ensure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="command_group"><a class="viewcode-back" href="../../../../onegov_core.html#onegov.core.cli.core.command_group">[docs]</a><span class="k">def</span> <span class="nf">command_group</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Generates a click command group for individual modules.</span>

<span class="sd">    Each individual module may have its own command group from which to run</span>
<span class="sd">    commands to. Read `&lt;http://click.pocoo.org/6/commands/&gt;`_ to learn more</span>
<span class="sd">    about command groups.</span>

<span class="sd">    The returned command group will provide the individual commands with</span>
<span class="sd">    an optional list of applications to operate on and it allows commands</span>
<span class="sd">    to return a callback function which will be invoked with the app config</span>
<span class="sd">    (if available), an application instance and a request.</span>

<span class="sd">    That is to say, the command group automates setting up a proper request</span>
<span class="sd">    context.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">invoke_without_command</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
        <span class="s1">&#39;--select&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Selects the applications this command should be applied to&quot;</span><span class="p">)</span>
    <span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
        <span class="s1">&#39;--config&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;onegov.yml&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The onegov config file&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">command_group</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">get_current_context</span><span class="p">()</span>
            <span class="n">context_settings</span> <span class="o">=</span> <span class="n">get_context_specific_settings</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">GroupContext</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="o">**</span><span class="n">context_settings</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">validate_guard_conditions</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DB_CONNECTION_ERRORS</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not connect to database:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@command_group</span><span class="o">.</span><span class="n">resultcallback</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">process_results</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calls the function returned by the command once for each</span>
<span class="sd">        application matching the selector.</span>

<span class="sd">        Uses a proper request/application context for ease of use.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">processor</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">processor</span><span class="p">):</span>
            <span class="n">processors</span> <span class="o">=</span> <span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">processors</span> <span class="o">=</span> <span class="n">processor</span>

        <span class="n">group_context</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">get_current_context</span><span class="p">()</span><span class="o">.</span><span class="n">obj</span>

        <span class="c1"># load all applications into the server</span>
        <span class="n">view_path</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="n">applications</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">appcfg</span> <span class="ow">in</span> <span class="n">group_context</span><span class="o">.</span><span class="n">appcfgs</span><span class="p">:</span>

            <span class="k">class</span> <span class="nc">CliApplication</span><span class="p">(</span><span class="n">appcfg</span><span class="o">.</span><span class="n">application_class</span><span class="p">):</span>

                <span class="k">def</span> <span class="nf">is_allowed_application_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application_id</span><span class="p">):</span>

                    <span class="k">if</span> <span class="n">group_context</span><span class="o">.</span><span class="n">creates_path</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>

                    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">is_allowed_application_id</span><span class="p">(</span><span class="n">application_id</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">configure_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">cfg</span><span class="p">):</span>
                    <span class="c1"># disable debug options in cli (like query output)</span>
                    <span class="k">pass</span>

            <span class="nd">@CliApplication</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">view_path</span><span class="p">)</span>
            <span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="nd">@CliApplication</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">Model</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="n">Public</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
                <span class="n">processor</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>

            <span class="nd">@CliApplication</span><span class="o">.</span><span class="n">setting</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;cronjobs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;enabled&#39;</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">get_cronjobs_enabled</span><span class="p">():</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="nd">@CliApplication</span><span class="o">.</span><span class="n">setting_section</span><span class="p">(</span><span class="n">section</span><span class="o">=</span><span class="s1">&#39;roles&#39;</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">get_roles_setting</span><span class="p">():</span>
                <span class="c1"># override the security settings -&gt; we need the public</span>
                <span class="c1"># role to work for anonymous users, even if the base</span>
                <span class="c1"># application disables that</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s1">&#39;anonymous&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">Public</span><span class="p">},</span>
                <span class="p">}</span>

            <span class="n">scan_morepath_modules</span><span class="p">(</span><span class="n">CliApplication</span><span class="p">)</span>
            <span class="n">CliApplication</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">applications</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="s1">&#39;application&#39;</span><span class="p">:</span> <span class="n">CliApplication</span><span class="p">,</span>
                <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span>
                <span class="s1">&#39;configuration&#39;</span><span class="p">:</span> <span class="n">appcfg</span><span class="o">.</span><span class="n">configuration</span>
            <span class="p">})</span>

        <span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span>
            <span class="n">Config</span><span class="p">({</span>
                <span class="s1">&#39;applications&#39;</span><span class="p">:</span> <span class="n">applications</span><span class="p">,</span>
                <span class="s1">&#39;logging&#39;</span><span class="p">:</span> <span class="n">group_context</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">logging</span>
            <span class="p">}),</span>
            <span class="n">configure_morepath</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">expects_request</span><span class="p">(</span><span class="n">processor</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;request&#39;</span> <span class="ow">in</span> <span class="n">processor</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span>

        <span class="c1"># call the matching applications</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">group_context</span><span class="o">.</span><span class="n">matches</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">processor</span> <span class="ow">in</span> <span class="n">processors</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expects_request</span><span class="p">(</span><span class="n">processor</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">group_context</span><span class="o">.</span><span class="n">match_to_path</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
                    <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">view_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">appcfg</span> <span class="o">=</span> <span class="n">group_context</span><span class="o">.</span><span class="n">match_to_appcfg</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>
                    <span class="n">processor</span><span class="p">(</span><span class="n">group_context</span><span class="p">,</span> <span class="n">appcfg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">command_group</span></div>


<div class="viewcode-block" id="abort"><a class="viewcode-back" href="../../../../onegov_core.html#onegov.core.cli.core.abort">[docs]</a><span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Prints the given error message and aborts the program with a return</span>
<span class="sd">    code of 1.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">click</span><span class="o">.</span><span class="n">secho</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">fg</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../../index.html">
    <img class="logo" src="../../../../_static/logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=OneGov&repo=onegov-docs&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Verein OneGov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>
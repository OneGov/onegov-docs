
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Onegov File API &#8212; OneGov Docs 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="onegov-file-api">
<h1>Onegov File API<a class="headerlink" href="#onegov-file-api" title="Permalink to this headline">¶</a></h1>
<div class="section" id="module-onegov.file.models.file">
<span id="models"></span><h2>Models<a class="headerlink" href="#module-onegov.file.models.file" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="onegov.file.models.file.UploadedFileField">
<em class="property">class </em><code class="descclassname">onegov.file.models.file.</code><code class="descname">UploadedFileField</code><span class="sig-paren">(</span><em>filters=()</em>, <em>upload_type=&lt;class 'depot.fields.upload.UploadedFile'&gt;</em>, <em>upload_storage=None</em>, <em>*args</em>, <em>**kw</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/models/file.html#UploadedFileField"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.models.file.UploadedFileField" title="Permalink to this definition">¶</a></dt>
<dd><p>A customized version of Depot’s uploaded file field. This version
stores its data in a JSONB field, instead of using text.</p>
<dl class="method">
<dt id="onegov.file.models.file.UploadedFileField.load_dialect_impl">
<code class="descname">load_dialect_impl</code><span class="sig-paren">(</span><em>dialect</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/models/file.html#UploadedFileField.load_dialect_impl"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.models.file.UploadedFileField.load_dialect_impl" title="Permalink to this definition">¶</a></dt>
<dd><p>Return a <code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code> object corresponding to a dialect.</p>
<p>This is an end-user override hook that can be used to provide
differing types depending on the given dialect.  It is used
by the <code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code> implementation of <code class="xref py py-meth docutils literal notranslate"><span class="pre">type_engine()</span></code>
to help determine what type should ultimately be returned
for a given <code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code>.</p>
<p>By default returns <code class="docutils literal notranslate"><span class="pre">self.impl</span></code>.</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.models.file.UploadedFileField.process_bind_param">
<code class="descname">process_bind_param</code><span class="sig-paren">(</span><em>value</em>, <em>dialect</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/models/file.html#UploadedFileField.process_bind_param"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.models.file.UploadedFileField.process_bind_param" title="Permalink to this definition">¶</a></dt>
<dd><p>Receive a bound parameter value to be converted.</p>
<p>Subclasses override this method to return the
value that should be passed along to the underlying
<code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code> object, and from there to the
DBAPI <code class="docutils literal notranslate"><span class="pre">execute()</span></code> method.</p>
<p>The operation could be anything desired to perform custom
behavior, such as transforming or serializing data.
This could also be used as a hook for validating logic.</p>
<p>This operation should be designed with the reverse operation
in mind, which would be the process_result_value method of
this class.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>value</strong> – Data to operate upon, of any type expected by
this method in the subclass.  Can be <code class="docutils literal notranslate"><span class="pre">None</span></code>.</li>
<li><strong>dialect</strong> – the <code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code> in use.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="onegov.file.models.file.UploadedFileField.process_result_value">
<code class="descname">process_result_value</code><span class="sig-paren">(</span><em>value</em>, <em>dialect</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/models/file.html#UploadedFileField.process_result_value"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.models.file.UploadedFileField.process_result_value" title="Permalink to this definition">¶</a></dt>
<dd><p>Receive a result-row column value to be converted.</p>
<p>Subclasses should implement this method to operate on data
fetched from the database.</p>
<p>Subclasses override this method to return the
value that should be passed back to the application,
given a value that is already processed by
the underlying <code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code> object, originally
from the DBAPI cursor method <code class="docutils literal notranslate"><span class="pre">fetchone()</span></code> or similar.</p>
<p>The operation could be anything desired to perform custom
behavior, such as transforming or serializing data.
This could also be used as a hook for validating logic.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>value</strong> – Data to operate upon, of any type expected by
this method in the subclass.  Can be <code class="docutils literal notranslate"><span class="pre">None</span></code>.</li>
<li><strong>dialect</strong> – the <code class="xref py py-class docutils literal notranslate"><span class="pre">Dialect</span></code> in use.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>This operation should be designed to be reversible by
the “process_bind_param” method of this class.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="onegov.file.models.file.SearchableFile">
<em class="property">class </em><code class="descclassname">onegov.file.models.file.</code><code class="descname">SearchableFile</code><a class="reference internal" href="_modules/onegov/file/models/file.html#SearchableFile"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.models.file.SearchableFile" title="Permalink to this definition">¶</a></dt>
<dd><p>Files are not made available for elasticsearch by default. This is
for security reasons - files are public by default but one has to know
the url (a very long id).</p>
<p>Search might lead to a disclosure of all files, which is why files
can only be searched if they are of a different polymorphic subclass
and use this mixin.</p>
<dl class="attribute">
<dt id="onegov.file.models.file.SearchableFile.es_suggestion">
<code class="descname">es_suggestion</code><a class="headerlink" href="#onegov.file.models.file.SearchableFile.es_suggestion" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns suggest-as-you-type value of the document.
The field used for this property should also be indexed, or the
suggestion will lead to nowhere.</p>
<p>If a single string is returned, the completion input equals the
completion output. (My Title -&gt; My Title)</p>
<p>If an array of strings is returned, all values are possible inputs and
the first value is the output. (My Title/Title My -&gt; My Title)</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.SearchableFile.es_public">
<code class="descname">es_public</code><a class="headerlink" href="#onegov.file.models.file.SearchableFile.es_public" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns True if the model is available to be found by the public.
If false, only editors/admins will see this object in the search
results.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="onegov.file.models.file.File">
<em class="property">class </em><code class="descclassname">onegov.file.models.file.</code><code class="descname">File</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/models/file.html#File"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.models.file.File" title="Permalink to this definition">¶</a></dt>
<dd><p>A general file (image, document, pdf, etc), referenced in the database.</p>
<p>Thanks to the use of <a class="reference external" href="http://depot.readthedocs.io">Depot</a> files
can be seemingly stored in the database (with transaction guarantees),
without actually storing it in the database.</p>
<dl class="attribute">
<dt id="onegov.file.models.file.File.id">
<code class="descname">id</code><a class="headerlink" href="#onegov.file.models.file.File.id" title="Permalink to this definition">¶</a></dt>
<dd><p>the unique, public id of the file</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.name">
<code class="descname">name</code><a class="headerlink" href="#onegov.file.models.file.File.name" title="Permalink to this definition">¶</a></dt>
<dd><p>the name of the file, incl. extension (not used for public links)</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.note">
<code class="descname">note</code><a class="headerlink" href="#onegov.file.models.file.File.note" title="Permalink to this definition">¶</a></dt>
<dd><p>a short note about the file (for captions, other information)</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.order">
<code class="descname">order</code><a class="headerlink" href="#onegov.file.models.file.File.order" title="Permalink to this definition">¶</a></dt>
<dd><p>the default order of files</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.published">
<code class="descname">published</code><a class="headerlink" href="#onegov.file.models.file.File.published" title="Permalink to this definition">¶</a></dt>
<dd><p>true if published</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.publish_date">
<code class="descname">publish_date</code><a class="headerlink" href="#onegov.file.models.file.File.publish_date" title="Permalink to this definition">¶</a></dt>
<dd><p>the date after which this file will be made public - this controls
the visibility of the object through the <code class="docutils literal notranslate"><span class="pre">is_hidden_from_public</span></code>
property which in turn is enforced by <a class="reference internal" href="onegov_core.html#module-onegov.core.security.rules" title="onegov.core.security.rules"><code class="xref py py-mod docutils literal notranslate"><span class="pre">onegov.core.security.rules</span></code></a>.</p>
<p>To get a file published, be sure to call
<a class="reference internal" href="#onegov.file.collection.FileCollection.publish_files" title="onegov.file.collection.FileCollection.publish_files"><code class="xref py py-meth docutils literal notranslate"><span class="pre">onegov.file.collection.FileCollection.publish_files()</span></code></a> once an
hour through a cronjob (see <a class="reference internal" href="onegov_core.html#module-onegov.core.cronjobs" title="onegov.core.cronjobs"><code class="xref py py-mod docutils literal notranslate"><span class="pre">onegov.core.cronjobs</span></code></a>)!</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.signed">
<code class="descname">signed</code><a class="headerlink" href="#onegov.file.models.file.File.signed" title="Permalink to this definition">¶</a></dt>
<dd><p>true if the file was digitally signed in the onegov cloud</p>
<p>(the file could be signed without this being true, but that would
amount to a signature created outside of our platform, which is
something we ignore)</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.signature_metadata">
<code class="descname">signature_metadata</code><a class="headerlink" href="#onegov.file.models.file.File.signature_metadata" title="Permalink to this definition">¶</a></dt>
<dd><p>the metadata of the signature - this should include the following
data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">old_digest</span><span class="p">:</span> <span class="n">The</span> <span class="n">sha</span><span class="o">-</span><span class="mi">256</span> <span class="nb">hash</span> <span class="n">before</span> <span class="n">the</span> <span class="n">file</span> <span class="n">was</span> <span class="n">signed</span>
<span class="o">-</span> <span class="n">new_digest</span><span class="p">:</span> <span class="n">The</span> <span class="n">sha</span><span class="o">-</span><span class="mi">256</span> <span class="nb">hash</span> <span class="n">after</span> <span class="n">the</span> <span class="n">file</span> <span class="n">was</span> <span class="n">signed</span>
<span class="o">-</span> <span class="n">signee</span><span class="p">:</span> <span class="n">The</span> <span class="n">username</span> <span class="n">of</span> <span class="n">the</span> <span class="n">user</span> <span class="n">that</span> <span class="n">signed</span> <span class="n">the</span> <span class="n">document</span>
<span class="o">-</span> <span class="n">timestamp</span><span class="p">:</span> <span class="n">The</span> <span class="n">time</span> <span class="n">the</span> <span class="n">document</span> <span class="n">was</span> <span class="n">signed</span> <span class="ow">in</span> <span class="n">UTC</span>
<span class="o">-</span> <span class="n">request_id</span><span class="p">:</span> <span class="n">A</span> <span class="n">unique</span> <span class="n">identifier</span> <span class="n">by</span> <span class="n">the</span> <span class="n">signing</span> <span class="n">service</span>
</pre></div>
</div>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.type">
<code class="descname">type</code><a class="headerlink" href="#onegov.file.models.file.File.type" title="Permalink to this definition">¶</a></dt>
<dd><p>the type of the file, this can be used to create custom polymorphic
subclasses. See <a class="reference external" href="http://docs.sqlalchemy.org/en/improve_toc/orm/extensions/declarative/inheritance.html">http://docs.sqlalchemy.org/en/improve_toc/orm/extensions/declarative/inheritance.html</a>.</p>
<p>not to be confused with the the actual filetype which is stored
on the <a class="reference internal" href="#onegov.file.models.file.File.reference" title="onegov.file.models.file.File.reference"><code class="xref py py-attr docutils literal notranslate"><span class="pre">reference</span></code></a>!</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.reference">
<code class="descname">reference</code><a class="headerlink" href="#onegov.file.models.file.File.reference" title="Permalink to this definition">¶</a></dt>
<dd><p>the reference to the actual file, uses depot to point to a file on
the local file system or somewhere else (e.g. S3)</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.checksum">
<code class="descname">checksum</code><a class="headerlink" href="#onegov.file.models.file.File.checksum" title="Permalink to this definition">¶</a></dt>
<dd><p>the md5 checksum of the file <em>before</em> it was processed by us, that is
if the file was very large and we in turn made it smaller, it’s the
checksum of the file before it was changed by us
this is useful to check if an uploaded file was already uploaded before</p>
<p>note, this is not meant to be cryptographically secure - this is
strictly a check of file duplicates, not protection against tampering</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.extract">
<code class="descname">extract</code><a class="headerlink" href="#onegov.file.models.file.File.extract" title="Permalink to this definition">¶</a></dt>
<dd><p>the content of the given file as text, if it can be extracted
(it is important that this column be loaded deferred by default, lest
we load massive amounts of text on simple queries)</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.stats">
<code class="descname">stats</code><a class="headerlink" href="#onegov.file.models.file.File.stats" title="Permalink to this definition">¶</a></dt>
<dd><p>statistics around the extract (number of pages, words, etc.)
those are usually set during file upload (as some information is
lost afterwards)</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.file_id">
<code class="descname">file_id</code><a class="headerlink" href="#onegov.file.models.file.File.file_id" title="Permalink to this definition">¶</a></dt>
<dd><p>The file_id of the contained reference.</p>
<p>If <code class="xref py py-attr docutils literal notranslate"><span class="pre">virtual_file_id</span></code> is not None, it is returned instead.</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.file.File.claimed_extension">
<code class="descname">claimed_extension</code><a class="headerlink" href="#onegov.file.models.file.File.claimed_extension" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the extension as defined by the file name or by the
content type (whatever is found first in this order).</p>
<p>Note that this extension could therefore not be correct. It is mainly
meant for display purposes.</p>
<p>If you need to know the type of a file you should use the
content type stored on the reference.</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.models.file.File.get_thumbnail_id">
<code class="descname">get_thumbnail_id</code><span class="sig-paren">(</span><em>size</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/models/file.html#File.get_thumbnail_id"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.models.file.File.get_thumbnail_id" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the thumbnail id with the given size (e.g. ‘small’).</p>
</dd></dl>

</dd></dl>

<span class="target" id="module-onegov.file.models.fileset"></span><dl class="class">
<dt id="onegov.file.models.fileset.FileSet">
<em class="property">class </em><code class="descclassname">onegov.file.models.fileset.</code><code class="descname">FileSet</code><span class="sig-paren">(</span><em>**kwargs</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/models/fileset.html#FileSet"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.models.fileset.FileSet" title="Permalink to this definition">¶</a></dt>
<dd><p>A set of files that belong together. Each file may be part of
none, one or many sets. Each set may containe none, one or many files.</p>
<p>The fileset uses uuids for public urls instead of a readable url-safe
name, because files are meant to be always public with an unguessable url,
and so the filesets containing files must also have the same property.</p>
<p>Otherwise we might not be able to guess the name the of the file, but we
will be able to guess the name of a fileset containing files.</p>
<dl class="attribute">
<dt id="onegov.file.models.fileset.FileSet.id">
<code class="descname">id</code><a class="headerlink" href="#onegov.file.models.fileset.FileSet.id" title="Permalink to this definition">¶</a></dt>
<dd><p>the unique, public id of the fileset</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.fileset.FileSet.title">
<code class="descname">title</code><a class="headerlink" href="#onegov.file.models.fileset.FileSet.title" title="Permalink to this definition">¶</a></dt>
<dd><p>the title of the fileset (not usable in url)</p>
</dd></dl>

<dl class="attribute">
<dt id="onegov.file.models.fileset.FileSet.type">
<code class="descname">type</code><a class="headerlink" href="#onegov.file.models.fileset.FileSet.type" title="Permalink to this definition">¶</a></dt>
<dd><p>the type of the fileset, this can be used to create custom polymorphic
subclasses. See <a class="reference external" href="http://docs.sqlalchemy.org/en/improve_toc/orm/extensions/declarative/inheritance.html">http://docs.sqlalchemy.org/en/improve_toc/orm/extensions/declarative/inheritance.html</a>.</p>
<p>this is independent from the <code class="xref py py-attr docutils literal notranslate"><span class="pre">onegov.file.models.File.type</span></code>
attribute on the <code class="xref py py-class docutils literal notranslate"><span class="pre">File</span></code>.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-onegov.file.collection">
<span id="collection"></span><h2>Collection<a class="headerlink" href="#module-onegov.file.collection" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="onegov.file.collection.FileCollection">
<em class="property">class </em><code class="descclassname">onegov.file.collection.</code><code class="descname">FileCollection</code><span class="sig-paren">(</span><em>session</em>, <em>type='*'</em>, <em>allow_duplicates=True</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection" title="Permalink to this definition">¶</a></dt>
<dd><p>Manages files.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>session</strong> – The SQLAlchemy db session to use.</li>
<li><strong>type</strong> – The polymorphic type to use and to filter for, or ‘*’ for all.</li>
<li><strong>allow_duplicates</strong> – <p>Prevents duplicates if set to false. Duplicates are detected before
pre-processing, so already stored files may be downloaded and
added again, as they might have changed during the upload.</p>
<p>Note that this does not change existing files. It only prevents
new duplicates from being added.</p>
</li>
</ul>
</td>
</tr>
</tbody>
</table>
<dl class="method">
<dt id="onegov.file.collection.FileCollection.add">
<code class="descname">add</code><span class="sig-paren">(</span><em>filename</em>, <em>content</em>, <em>note=None</em>, <em>published=True</em>, <em>publish_date=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.add"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.add" title="Permalink to this definition">¶</a></dt>
<dd><p>Adds a file with the given filename. The content maybe either
in bytes or a file object.</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.replace">
<code class="descname">replace</code><span class="sig-paren">(</span><em>file</em>, <em>content</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.replace"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.replace" title="Permalink to this definition">¶</a></dt>
<dd><p>Replaces the content of the given file with the new content.</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.publishable_files">
<code class="descname">publishable_files</code><span class="sig-paren">(</span><em>horizon=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.publishable_files"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.publishable_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Yields files which may be published.</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.publish_files">
<code class="descname">publish_files</code><span class="sig-paren">(</span><em>horizon=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.publish_files"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.publish_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Publishes unpublished files with a publish date older than the
given horizon.</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.by_id">
<code class="descname">by_id</code><span class="sig-paren">(</span><em>file_id</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.by_id"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.by_id" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the file with the given id or None.</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.by_filename">
<code class="descname">by_filename</code><span class="sig-paren">(</span><em>filename</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.by_filename"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.by_filename" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a query that matches the files with the given filename.</p>
<p>Be aware that there may be multiple files with the same filename!</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.by_checksum">
<code class="descname">by_checksum</code><span class="sig-paren">(</span><em>checksum</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.by_checksum"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.by_checksum" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a query that matches the given checksum (may be more than
one record).</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.by_content">
<code class="descname">by_content</code><span class="sig-paren">(</span><em>content</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.by_content"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.by_content" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a query that matches the given content (may be more than
one record).</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.by_content_type">
<code class="descname">by_content_type</code><span class="sig-paren">(</span><em>content_type</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.by_content_type"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.by_content_type" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a query that matches the given MIME content type (may be
more than one record).</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.by_signature_digest">
<code class="descname">by_signature_digest</code><span class="sig-paren">(</span><em>digest</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.by_signature_digest"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.by_signature_digest" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a query that matches the given digest in the signature
metadata. In other words, given a digest this function will find
signed files that match the digest - either before or after signing.</p>
<p>Unsigned files are ignored.</p>
<p>The digest is expected to be a SHA256 hex.</p>
</dd></dl>

<dl class="method">
<dt id="onegov.file.collection.FileCollection.locate_signature_metadata">
<code class="descname">locate_signature_metadata</code><span class="sig-paren">(</span><em>digest</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileCollection.locate_signature_metadata"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileCollection.locate_signature_metadata" title="Permalink to this definition">¶</a></dt>
<dd><p>Looks for the given digest in the files table - if that doesn’t
work it will go through the audit trail (i.e. the chat messages) and
see if the digest can be found there.</p>
<p>If this database was ever used to sign a file with the given digest,
or if a file that was signed had the given digest, this function
will find it - barring manual database manipulation in the messages
log.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="onegov.file.collection.FileSetCollection">
<em class="property">class </em><code class="descclassname">onegov.file.collection.</code><code class="descname">FileSetCollection</code><span class="sig-paren">(</span><em>session</em>, <em>type='*'</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileSetCollection"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileSetCollection" title="Permalink to this definition">¶</a></dt>
<dd><p>Manages filesets.</p>
<dl class="method">
<dt id="onegov.file.collection.FileSetCollection.by_id">
<code class="descname">by_id</code><span class="sig-paren">(</span><em>fileset_id</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/collection.html#FileSetCollection.by_id"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.collection.FileSetCollection.by_id" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the fileset with the given id or None.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-onegov.file.integration">
<span id="integration"></span><h2>Integration<a class="headerlink" href="#module-onegov.file.integration" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="onegov.file.integration.DepotApp">
<em class="property">class </em><code class="descclassname">onegov.file.integration.</code><code class="descname">DepotApp</code><a class="reference internal" href="_modules/onegov/file/integration.html#DepotApp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.integration.DepotApp" title="Permalink to this definition">¶</a></dt>
<dd><p>Provides <a class="reference external" href="depot.readthedocs.io">Depot</a> integration for
<a class="reference internal" href="onegov_core.html#onegov.core.framework.Framework" title="onegov.core.framework.Framework"><code class="xref py py-class docutils literal notranslate"><span class="pre">onegov.core.framework.Framework</span></code></a> based applications.</p>
<dl class="method">
<dt id="onegov.file.integration.DepotApp.configure_files">
<code class="descname">configure_files</code><span class="sig-paren">(</span><em>**cfg</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/integration.html#DepotApp.configure_files"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.integration.DepotApp.configure_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Configures the file/depot integration. The following configuration
options are accepted:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Depot_backend:</th><td class="field-body"><p class="first">The depot backend to use. Supported values:</p>
<ul class="simple">
<li>depot.io.local.LocalFileStorage</li>
<li>depot.io.memory.MemoryFileStorage</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Depot_storage_path:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><p class="first">The storage path used by the local file storage.</p>
<p>Note that the actual files are stored under a subdirectory specific
to each application id. This is mainly to keep a handle on which
file belongs to which application. Additionally it ensures that we
aren’t accidentally opening another application’s files.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Frontend_cache_buster:</th></tr>
<tr class="field-odd field"><td>&#160;</td><td class="field-body"><p class="first">A script able to bust the frontend cache.</p>
<p>Our frontend (nginx) caches the files we store in the backend and
serves them mostly without bothering us. This can be problematic
when the file is deleted or if it is made private. The cache
needs to be busted in this case.</p>
<p>With this configuration a script/command can be specified that
receives the url that needs to be busted and in turn busts the
content of this url from the cache. This pretty much depends
on the platform this is run and on the frontend in use.</p>
<p>For example, let’s say our script is called ‘bust-cache’, this
is the command that will be run when the cache is busted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sleep</span> <span class="mi">5</span>
<span class="n">bust</span><span class="o">-</span><span class="n">cache</span> <span class="nb">id</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">the</span><span class="o">-</span><span class="n">file</span>
</pre></div>
</div>
<p>As you can see, the command is invoked with a five second delay.
This avoids premature cache busting (before the end of the
transaction). The command is non-blocking, so those 5 seconds
are not counted towards the request-time.</p>
<p>Frontend caches might use the domain and the full path to cache
a file, but since we can technically have multiple domains/paths
point to the same file we simply pass the id and let the cache
figure out what urls need to be busted as a result.</p>
<p>The script is invoked with the permissions of the user running
the backend. If other permissions are required, use suid.</p>
<p>Note that this script is optional. If omitted, the cache busting
turns into a noop.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Signing_services:</th></tr>
<tr class="field-even field"><td>&#160;</td><td class="field-body"><p class="first">Contains signing service configs.</p>
<p>Each application gets exactly one signing service.</p>
<p>This integration class will take care of instantiating the
signing service and offer it through <cite>self.signing_service</cite>.</p>
<p>The signing service can be used with any file, though there is
first-class support for signing onegov.file models.</p>
<p>Signing services are implemented using sublcasses of the
<code class="xref py py-class docutils literal notranslate"><span class="pre">onegov.file.sign.SigningService</span></code>. Each signature
service class is configured using a single yaml file which is
stored in the signature config path.</p>
<p>By default we use the ‘__default__.yaml’ config. Alternatively
we can create separate configs for various application ids.</p>
<p class="last">For example, we might create a <cite>onegov_town-govikon.yaml</cite>, which
would take precedence over the default config, if the application
with the id <cite>onegov_town-govikon</cite> would use the signing service.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="onegov.file.integration.DepotApp.sign_file">
<code class="descname">sign_file</code><span class="sig-paren">(</span><em>file</em>, <em>signee</em>, <em>token</em>, <em>token_type='yubikey'</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/integration.html#DepotApp.sign_file"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.integration.DepotApp.sign_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Signs the given file and stores metadata about that process.</p>
<p>During signing the stored file is replaced with the signed version.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pdf</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">sign_file</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="s1">&#39;info@example.org&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>file</strong> – The <code class="xref py py-class docutils literal notranslate"><span class="pre">onegov.file..File</span></code> instance to sign.</li>
<li><strong>signee</strong> – The name of the signee (should be a username).</li>
<li><strong>token</strong> – <p>The (yubikey) token used to sign the file.</p>
<p>WARNING: It is the job of the caller to ensure that the yubikey has
the right to sign the document (i.e. that it is the right yubikey).</p>
</li>
<li><strong>token_type</strong> – They type of the passed token. Currently only ‘yubikey’.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="onegov.file.integration.DepotApp.temporary_depot">
<code class="descname">temporary_depot</code><span class="sig-paren">(</span><em>depot_id</em>, <em>**configuration</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/integration.html#DepotApp.temporary_depot"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.integration.DepotApp.temporary_depot" title="Permalink to this definition">¶</a></dt>
<dd><p>Temporarily use another depot.</p>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="onegov.file.integration.delete_file">
<code class="descclassname">onegov.file.integration.</code><code class="descname">delete_file</code><span class="sig-paren">(</span><em>self</em>, <em>request</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/integration.html#delete_file"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.integration.delete_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes the given file. By default the permission is
<code class="docutils literal notranslate"><span class="pre">Private</span></code>. An application using the framework can override this though.</p>
<p>Since a DELETE can only be sent through AJAX it is protected by the
same-origin policy. That means that we don’t need to use any CSRF
protection here.</p>
<p>That being said, browser bugs and future changes in the HTML standard
make it possible for this to happen one day. Therefore, a time-limited
token must be passed as query parameter to this function.</p>
<p>New tokens can be acquired through <code class="docutils literal notranslate"><span class="pre">request.new_csrf_token</span></code>.</p>
</dd></dl>

</div>
<div class="section" id="module-onegov.file.attachments">
<span id="attachments"></span><h2>Attachments<a class="headerlink" href="#module-onegov.file.attachments" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="onegov.file.attachments.ProcessedUploadedFile">
<em class="property">class </em><code class="descclassname">onegov.file.attachments.</code><code class="descname">ProcessedUploadedFile</code><span class="sig-paren">(</span><em>content</em>, <em>depot_name=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/attachments.html#ProcessedUploadedFile"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.attachments.ProcessedUploadedFile" title="Permalink to this definition">¶</a></dt>
<dd><dl class="method">
<dt id="onegov.file.attachments.ProcessedUploadedFile.process_content">
<code class="descname">process_content</code><span class="sig-paren">(</span><em>content</em>, <em>filename=None</em>, <em>content_type=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/attachments.html#ProcessedUploadedFile.process_content"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.attachments.ProcessedUploadedFile.process_content" title="Permalink to this definition">¶</a></dt>
<dd><p>Standard implementation of <code class="xref py py-meth docutils literal notranslate"><span class="pre">DepotFileInfo.process_content()</span></code></p>
<p>This is the standard depot implementation of files upload, it will
store the file on the default depot and will provide the standard
attributes.</p>
<p>Subclasses will need to call this method to ensure the standard
set of attributes is provided.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-onegov.file.filters">
<span id="filters"></span><h2>Filters<a class="headerlink" href="#module-onegov.file.filters" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="onegov.file.filters.ConditionalFilter">
<em class="property">class </em><code class="descclassname">onegov.file.filters.</code><code class="descname">ConditionalFilter</code><span class="sig-paren">(</span><em>filter</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/filters.html#ConditionalFilter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.filters.ConditionalFilter" title="Permalink to this definition">¶</a></dt>
<dd><p>A depot filter that’s only run if a condition is met. The condition
is defined by overriding the :meth:<code class="docutils literal notranslate"><span class="pre">meets_condition</span></code> returns True.</p>
<dl class="method">
<dt id="onegov.file.filters.ConditionalFilter.on_save">
<code class="descname">on_save</code><span class="sig-paren">(</span><em>uploaded_file</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/filters.html#ConditionalFilter.on_save"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.filters.ConditionalFilter.on_save" title="Permalink to this definition">¶</a></dt>
<dd><p>Filters are required to provide their own implementation</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="onegov.file.filters.OnlyIfImage">
<em class="property">class </em><code class="descclassname">onegov.file.filters.</code><code class="descname">OnlyIfImage</code><span class="sig-paren">(</span><em>filter</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/filters.html#OnlyIfImage"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.filters.OnlyIfImage" title="Permalink to this definition">¶</a></dt>
<dd><p>A conditional filter that runs the passed filter only if the
uploaded file is an image.</p>
</dd></dl>

<dl class="class">
<dt id="onegov.file.filters.OnlyIfPDF">
<em class="property">class </em><code class="descclassname">onegov.file.filters.</code><code class="descname">OnlyIfPDF</code><span class="sig-paren">(</span><em>filter</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/filters.html#OnlyIfPDF"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.filters.OnlyIfPDF" title="Permalink to this definition">¶</a></dt>
<dd><p>A conditional filter that runs the passed filter only if the
uploaded file is a pdf.</p>
</dd></dl>

<dl class="class">
<dt id="onegov.file.filters.WithThumbnailFilter">
<em class="property">class </em><code class="descclassname">onegov.file.filters.</code><code class="descname">WithThumbnailFilter</code><span class="sig-paren">(</span><em>name</em>, <em>size</em>, <em>format</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/filters.html#WithThumbnailFilter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.filters.WithThumbnailFilter" title="Permalink to this definition">¶</a></dt>
<dd><p>Uploads a thumbnail together with the file.</p>
<p>Takes for granted that the file is an image.</p>
<p>The resulting uploaded file will provide an additional property
<code class="docutils literal notranslate"><span class="pre">thumbnail_name</span></code>, which will contain the id and the path to the
thumbnail. The name is replaced with the name given to the filter.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Requires Pillow library</p>
</div>
<p>Note: This has been copied from Depot and adjusted for our use. Changes
include a different storage format, no storage of the url and replacement
of thumbnails instead of recreation (if possible).</p>
<dl class="method">
<dt id="onegov.file.filters.WithThumbnailFilter.on_save">
<code class="descname">on_save</code><span class="sig-paren">(</span><em>uploaded_file</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/filters.html#WithThumbnailFilter.on_save"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.filters.WithThumbnailFilter.on_save" title="Permalink to this definition">¶</a></dt>
<dd><p>Filters are required to provide their own implementation</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="onegov.file.filters.WithPDFThumbnailFilter">
<em class="property">class </em><code class="descclassname">onegov.file.filters.</code><code class="descname">WithPDFThumbnailFilter</code><span class="sig-paren">(</span><em>name</em>, <em>size</em>, <em>format</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/onegov/file/filters.html#WithPDFThumbnailFilter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#onegov.file.filters.WithPDFThumbnailFilter" title="Permalink to this definition">¶</a></dt>
<dd><p>Uploads a preview thumbnail as PNG together with the file.</p>
<p>This is basically the PDF implementation for <cite>WithThumbnailFilter</cite>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Requires the presence of ghostscript (gs binary) on the PATH.</p>
</div>
</dd></dl>

</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo.svg" alt="Logo"/>
    
  </a>
</p>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=OneGov&repo=onegov-docs&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Verein OneGov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/onegov_file.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>